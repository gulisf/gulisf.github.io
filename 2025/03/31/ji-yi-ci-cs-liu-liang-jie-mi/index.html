<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>记一次CS流量解密 | Gulisf's Home</title><meta name="author" content="gulisf"><meta name="copyright" content="gulisf"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="0x01 获取公私钥首先找到.cobaltstrike.beacon_keys，获取公私钥这里用的是mrI64师傅的代码 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354import base64import javaobj.v2 as javaob">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次CS流量解密">
<meta property="og:url" content="https://gulisf.github.io/2025/03/31/ji-yi-ci-cs-liu-liang-jie-mi/index.html">
<meta property="og:site_name" content="Gulisf&#39;s Home">
<meta property="og:description" content="0x01 获取公私钥首先找到.cobaltstrike.beacon_keys，获取公私钥这里用的是mrI64师傅的代码 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354import base64import javaobj.v2 as javaob">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409201930403.jpg">
<meta property="article:published_time" content="2025-03-30T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-31T14:33:31.889Z">
<meta property="article:author" content="gulisf">
<meta property="article:tag" content="流量分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409201930403.jpg"><link rel="shortcut icon" href="/imag/fac.png"><link rel="canonical" href="https://gulisf.github.io/2025/03/31/ji-yi-ci-cs-liu-liang-jie-mi/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '记一次CS流量解密',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-31 22:33:31'
}</script><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/hont.css"><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/imag/gulisf.jpg" onerror="onerror=null;src='/imag/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409201930403.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Gulisf's Home</span></a><a class="nav-page-title" href="/"><span class="site-name">记一次CS流量解密</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">记一次CS流量解密</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-30T16:00:00.000Z" title="发表于 2025-03-31 00:00:00">2025-03-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-31T14:33:31.889Z" title="更新于 2025-03-31 22:33:31">2025-03-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/misc/">misc</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>45分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="0x01-获取公私钥"><a href="#0x01-获取公私钥" class="headerlink" title="0x01 获取公私钥"></a>0x01 获取公私钥</h1><p>首先找到.cobaltstrike.beacon_keys，获取公私钥<br>这里用的是mrI64师傅的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">import javaobj.v2 as javaobj</span><br><span class="line">from typing import Tuple</span><br><span class="line"> </span><br><span class="line">def load_beacon_keys(file_path: str) -&gt; Tuple[bytes, bytes]:</span><br><span class="line">    &quot;&quot;&quot;加载Cobalt Strike的beacon密钥文件并提取公私钥数据&quot;&quot;&quot;</span><br><span class="line">    try:</span><br><span class="line">        with open(file_path, &quot;rb&quot;) as fd:</span><br><span class="line">            pobj = javaobj.load(fd)</span><br><span class="line">            # 提取原始密钥字节数据</span><br><span class="line">            private_data = bytes([x &amp; 0xFF for x in pobj.array.value.privateKey.encoded.data])</span><br><span class="line">            public_data = bytes([x &amp; 0xFF for x in pobj.array.value.publicKey.encoded.data])</span><br><span class="line">            return private_data, public_data</span><br><span class="line">    except FileNotFoundError:</span><br><span class="line">        raise FileNotFoundError(f&quot;密钥文件 &#123;file_path&#125; 不存在&quot;)</span><br><span class="line">    except AttributeError:</span><br><span class="line">        raise ValueError(&quot;文件格式错误，无法解析Java对象结构&quot;)</span><br><span class="line"> </span><br><span class="line">def generate_pem(key_data: bytes, key_type: str) -&gt; str:</span><br><span class="line">    &quot;&quot;&quot;将原始密钥数据转换为PEM格式&quot;&quot;&quot;</span><br><span class="line">    pem_header = f&quot;-----BEGIN &#123;key_type&#125; KEY-----\n&quot;</span><br><span class="line">    pem_footer = f&quot;\n-----END &#123;key_type&#125; KEY-----&quot;</span><br><span class="line">    </span><br><span class="line">    # Base64编码并格式化为64字符宽度</span><br><span class="line">    b64_data = base64.encodebytes(key_data).decode(&quot;utf-8&quot;)</span><br><span class="line">    formatted_b64 = &quot;\n&quot;.join([b64_data[i:i+64] for i in range(0, len(b64_data), 64)])</span><br><span class="line">    </span><br><span class="line">    return f&quot;&#123;pem_header&#125;&#123;formatted_b64&#125;&#123;pem_footer&#125;&quot;</span><br><span class="line"> </span><br><span class="line">def main():</span><br><span class="line">    try:</span><br><span class="line">        # 加载密钥数据</span><br><span class="line">        private_data, public_data = load_beacon_keys(&quot;.cobaltstrike.beacon_keys&quot;)</span><br><span class="line">        </span><br><span class="line">        # 生成PEM格式</span><br><span class="line">        private_pem = generate_pem(private_data, &quot;PRIVATE&quot;)</span><br><span class="line">        public_pem = generate_pem(public_data, &quot;PUBLIC&quot;)</span><br><span class="line">        </span><br><span class="line">        # 输出结果</span><br><span class="line">        print(&quot;[Private Key]\n&quot; + private_pem)</span><br><span class="line">        print(&quot;\n[Public Key]\n&quot; + public_pem)</span><br><span class="line">        </span><br><span class="line">        # 保存到文件（可选）</span><br><span class="line">        with open(&quot;private.key&quot;, &quot;w&quot;) as f:</span><br><span class="line">            f.write(private_pem)</span><br><span class="line">        with open(&quot;public.key&quot;, &quot;w&quot;) as f:</span><br><span class="line">            f.write(public_pem)</span><br><span class="line">            </span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(f&quot;错误: &#123;str(e)&#125;&quot;)</span><br><span class="line">        exit(1)</span><br><span class="line"> </span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<p><img src="image-20250331222434442.png"></p>
<h1 id="0x02-获取key"><a href="#0x02-获取key" class="headerlink" title="0x02 获取key"></a>0x02 获取key</h1><p>然后用cs-decrypt-metadata.py获取rawkey（即cookie值）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line">from __future__ import print_function</span><br><span class="line"></span><br><span class="line">__description__ = &#x27;Cobalt Strike: RSA decrypt metadata&#x27;</span><br><span class="line">__author__ = &#x27;Didier Stevens&#x27;</span><br><span class="line">__version__ = &#x27;0.0.5&#x27;</span><br><span class="line">__date__ = &#x27;2025/02/09&#x27;</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Source code put in the public domain by Didier Stevens, no Copyright</span><br><span class="line">https://DidierStevens.com</span><br><span class="line">Use at your own risk</span><br><span class="line"></span><br><span class="line">History:</span><br><span class="line">  2021/10/10: start</span><br><span class="line">  2021/10/20: refactoring</span><br><span class="line">  2021/10/26: 0.0.2 parsing binary IPv4 address</span><br><span class="line">  2021/11/10: error handling decrypting; added option -t</span><br><span class="line">  2021/11/11: 0.0.3 refactoring: cCSInstructions, cOutput</span><br><span class="line">  2021/11/15: bugfix decoding</span><br><span class="line">  2021/12/16: 0.0.4 bugfix</span><br><span class="line">  2022/10/23: 0.0.5 added option -V</span><br><span class="line">  2025/02/09: added warning when file 1768.json is missing</span><br><span class="line"></span><br><span class="line">Todo:</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">import binascii</span><br><span class="line">import struct</span><br><span class="line">import hashlib</span><br><span class="line">import re</span><br><span class="line">import optparse</span><br><span class="line">import os</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line">import textwrap</span><br><span class="line">import base64</span><br><span class="line">import time</span><br><span class="line">try:</span><br><span class="line">    import Crypto.PublicKey.RSA</span><br><span class="line">    import Crypto.Cipher.PKCS1_v1_5</span><br><span class="line">except ImportError:</span><br><span class="line">    print(&#x27;pycrypto module is required: pip install pycryptodome&#x27;)</span><br><span class="line">    exit(-1)</span><br><span class="line">try:</span><br><span class="line">    import javaobj</span><br><span class="line">except ImportError:</span><br><span class="line">    javaobj = None</span><br><span class="line"></span><br><span class="line">def PrintManual():</span><br><span class="line">    manual = r&#x27;&#x27;&#x27;</span><br><span class="line">Manual:</span><br><span class="line"></span><br><span class="line">This tool decrypts metadata sent by a Cobalt Strike beacon to its team server.</span><br><span class="line">Provide the metadata in base64 format as argument. More than one argument can be provided.</span><br><span class="line">Decrypting metadata requires a private key.</span><br><span class="line">A private key can be provided with option -p in hexadecimal format or with option -f as a file (.cobaltstrike.beacon_keys).</span><br><span class="line">If no private key is provided, all private keys in file 1768.json are tried.</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line"></span><br><span class="line">cs-decrypt-metadata.py KN9zfIq31DBBdLtF4JUjmrhm0lRKkC/I/zAiJ+Xxjz787h9yh35cRjEnXJAwQcWP4chXobXT/E5YrZjgreeGTrORnj//A5iZw2TClEnt++gLMyMHwgjsnvg9czGx6Ekpz0L1uEfkVoo4MpQ0/kJk9myZagRrPrFWdE9U7BwCzlE=</span><br><span class="line"></span><br><span class="line">Input: KN9zfIq31DBBdLtF4JUjmrhm0lRKkC/I/zAiJ+Xxjz787h9yh35cRjEnXJAwQcWP4chXobXT/E5YrZjgreeGTrORnj//A5iZw2TClEnt++gLMyMHwgjsnvg9czGx6Ekpz0L1uEfkVoo4MpQ0/kJk9myZagRrPrFWdE9U7BwCzlE=</span><br><span class="line">Encrypted metadata: 28df737c8ab7d4304174bb45e095239ab866d2544a902fc8ff302227e5f18f3efcee1f72877e5c4631275c903041c58fe1c857a1b5d3fc4e58ad98e0ade7864eb3919e3fff039899c364c29449edfbe80b332307c208ec9ef83d7331b1e84929cf42f5b847e4568a38329434fe4264f66c996a046b3eb156744f54ec1c02ce51</span><br><span class="line">Decrypted:</span><br><span class="line">Header: 0000beef</span><br><span class="line">Datasize: 0000005d</span><br><span class="line">Raw key:  caeab4f452fe41182d504aa24966fbd0</span><br><span class="line"> aeskey:  3342f45e6e2f71f5975c998600b11471</span><br><span class="line"> hmackey: 7142dd70f4ec320badac8ca246a9488f</span><br><span class="line">charset: 04e4 ANSI Latin 1; Western European (Windows)</span><br><span class="line">charset_oem: 01b5 OEM United States</span><br><span class="line">bid: 644d8e4 105175268</span><br><span class="line">pid: 1c7c 7292</span><br><span class="line">port: 0</span><br><span class="line">flags: 04</span><br><span class="line">var1: 10</span><br><span class="line">var2: 0</span><br><span class="line">var3: 19042</span><br><span class="line">var4: 0</span><br><span class="line">var5: 1988364896</span><br><span class="line">var6: 1988359504</span><br><span class="line">Internal IPv4: 10.6.9.111</span><br><span class="line">Field: b&#x27;DESKTOP-Q21RU7A&#x27;</span><br><span class="line">Field: b&#x27;maxwell.carter&#x27;</span><br><span class="line">Field: b&#x27;svchost.exe&#x27;</span><br><span class="line"></span><br><span class="line">By default, metadata is BASE64 encoded. If another transformation is used by the beacon to encode the metadata, option -t can be used to transform the metadata prior to decrypting.</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line"></span><br><span class="line">cs-decrypt-metadata.py -t 7:Metadata,13,2:__cfduid=,6:Cookie __cfduid=GQ-rUvFDD0WewXldmHhCkZybJ5OB4ZrwbRbN6K4St2Jr7W1L0FR0eSZSdHtt0i9JHBBUzRnQj1U4a0a4meC9YMvgvdSIQ4QlqNEw5GMDKkTYjAcNRRCe3QYZ2FeW4dn5SALu70Eb7F5VzDoFcG_Hq3akmQpHH-RBWPYNxTX2fsE</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">    for line in manual.split(&#x27;\n&#x27;):</span><br><span class="line">        print(textwrap.fill(line, 79))</span><br><span class="line"></span><br><span class="line">DEFAULT_SEPARATOR = &#x27;,&#x27;</span><br><span class="line">QUOTE = &#x27;&quot;&#x27;</span><br><span class="line"></span><br><span class="line">def IfWIN32SetBinary(io):</span><br><span class="line">    if sys.platform == &#x27;win32&#x27;:</span><br><span class="line">        import msvcrt</span><br><span class="line">        msvcrt.setmode(io.fileno(), os.O_BINARY)</span><br><span class="line"></span><br><span class="line">#Fix for http://bugs.python.org/issue11395</span><br><span class="line">def StdoutWriteChunked(data):</span><br><span class="line">    if sys.version_info[0] &gt; 2:</span><br><span class="line">        if isinstance(data, str):</span><br><span class="line">            sys.stdout.write(data)</span><br><span class="line">        else:</span><br><span class="line">            sys.stdout.buffer.write(data)</span><br><span class="line">    else:</span><br><span class="line">        while data != &#x27;&#x27;:</span><br><span class="line">            sys.stdout.write(data[0:10000])</span><br><span class="line">            try:</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">            except IOError:</span><br><span class="line">                return</span><br><span class="line">            data = data[10000:]</span><br><span class="line"></span><br><span class="line">class cVariables():</span><br><span class="line">    def __init__(self, variablesstring=&#x27;&#x27;, separator=DEFAULT_SEPARATOR):</span><br><span class="line">        self.dVariables = &#123;&#125;</span><br><span class="line">        if variablesstring == &#x27;&#x27;:</span><br><span class="line">            return</span><br><span class="line">        for variable in variablesstring.split(separator):</span><br><span class="line">            name, value = VariableNameValue(variable)</span><br><span class="line">            self.dVariables[name] = value</span><br><span class="line"></span><br><span class="line">    def SetVariable(self, name, value):</span><br><span class="line">        self.dVariables[name] = value</span><br><span class="line"></span><br><span class="line">    def Instantiate(self, astring):</span><br><span class="line">        for key, value in self.dVariables.items():</span><br><span class="line">            astring = astring.replace(&#x27;%&#x27; + key + &#x27;%&#x27;, value)</span><br><span class="line">        return astring</span><br><span class="line"></span><br><span class="line">class cOutput():</span><br><span class="line">    def __init__(self, filenameOption=None, binary=False):</span><br><span class="line">        self.starttime = time.time()</span><br><span class="line">        self.filenameOption = filenameOption</span><br><span class="line">        self.separateFiles = False</span><br><span class="line">        self.progress = False</span><br><span class="line">        self.console = False</span><br><span class="line">        self.head = False</span><br><span class="line">        self.headCounter = 0</span><br><span class="line">        self.tail = False</span><br><span class="line">        self.tailQueue = []</span><br><span class="line">        self.STDOUT = &#x27;STDOUT&#x27;</span><br><span class="line">        self.fOut = None</span><br><span class="line">        self.oCsvWriter = None</span><br><span class="line">        self.rootFilenames = &#123;&#125;</span><br><span class="line">        self.binary = binary</span><br><span class="line">        if self.binary:</span><br><span class="line">            self.fileoptions = &#x27;wb&#x27;</span><br><span class="line">        else:</span><br><span class="line">            self.fileoptions = &#x27;w&#x27;</span><br><span class="line">        self.dReplacements = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    def Replace(self, line):</span><br><span class="line">        for key, value in self.dReplacements.items():</span><br><span class="line">            line = line.replace(key, value)</span><br><span class="line">        return line</span><br><span class="line"></span><br><span class="line">    def Open(self, binary=False):</span><br><span class="line">        if self.fOut != None:</span><br><span class="line">            return</span><br><span class="line"></span><br><span class="line">        if binary:</span><br><span class="line">            self.fileoptions = &#x27;wb&#x27;</span><br><span class="line">        else:</span><br><span class="line">            self.fileoptions = &#x27;w&#x27;</span><br><span class="line"></span><br><span class="line">        if self.filenameOption:</span><br><span class="line">            if self.ParseHash(self.filenameOption):</span><br><span class="line">                if not self.separateFiles and self.filename != &#x27;&#x27;:</span><br><span class="line">                    self.fOut = open(self.filename, self.fileoptions)</span><br><span class="line">            elif self.filenameOption != &#x27;&#x27;:</span><br><span class="line">                self.fOut = open(self.filenameOption, self.fileoptions)</span><br><span class="line">        else:</span><br><span class="line">            self.fOut = self.STDOUT</span><br><span class="line"></span><br><span class="line">    def ParseHash(self, option):</span><br><span class="line">        if option.startswith(&#x27;#&#x27;):</span><br><span class="line">            position = self.filenameOption.find(&#x27;#&#x27;, 1)</span><br><span class="line">            if position &gt; 1:</span><br><span class="line">                switches = self.filenameOption[1:position]</span><br><span class="line">                self.filename = self.filenameOption[position + 1:]</span><br><span class="line">                for switch in switches:</span><br><span class="line">                    if switch == &#x27;s&#x27;:</span><br><span class="line">                        self.separateFiles = True</span><br><span class="line">                    elif switch == &#x27;p&#x27;:</span><br><span class="line">                        self.progress = True</span><br><span class="line">                    elif switch == &#x27;c&#x27;:</span><br><span class="line">                        self.console = True</span><br><span class="line">                    elif switch == &#x27;l&#x27;:</span><br><span class="line">                        pass</span><br><span class="line">                    elif switch == &#x27;g&#x27;:</span><br><span class="line">                        if self.filename != &#x27;&#x27;:</span><br><span class="line">                            extra = self.filename + &#x27;-&#x27;</span><br><span class="line">                        else:</span><br><span class="line">                            extra = &#x27;&#x27;</span><br><span class="line">                        self.filename = &#x27;%s-%s%s.txt&#x27; % (os.path.splitext(os.path.basename(sys.argv[0]))[0], extra, self.FormatTime())</span><br><span class="line">                    elif switch == &#x27;h&#x27;:</span><br><span class="line">                        self.head = True</span><br><span class="line">                    elif switch == &#x27;t&#x27;:</span><br><span class="line">                        self.tail = True</span><br><span class="line">                    else:</span><br><span class="line">                        return False</span><br><span class="line">                return True</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def FormatTime(epoch=None):</span><br><span class="line">        if epoch == None:</span><br><span class="line">            epoch = time.time()</span><br><span class="line">        return &#x27;%04d%02d%02d-%02d%02d%02d&#x27; % time.localtime(epoch)[0:6]</span><br><span class="line"></span><br><span class="line">    def RootUnique(self, root):</span><br><span class="line">        if not root in self.rootFilenames:</span><br><span class="line">            self.rootFilenames[root] = None</span><br><span class="line">            return root</span><br><span class="line">        iter = 1</span><br><span class="line">        while True:</span><br><span class="line">            newroot = &#x27;%s_%04d&#x27; % (root, iter)</span><br><span class="line">            if not newroot in self.rootFilenames:</span><br><span class="line">                self.rootFilenames[newroot] = None</span><br><span class="line">                return newroot</span><br><span class="line">            iter += 1</span><br><span class="line"></span><br><span class="line">    def LineSub(self, line, eol):</span><br><span class="line">        line = self.Replace(line)</span><br><span class="line">        self.Open()</span><br><span class="line">        if self.fOut == self.STDOUT or self.console:</span><br><span class="line">            try:</span><br><span class="line">                print(line, end=eol)</span><br><span class="line">            except UnicodeEncodeError:</span><br><span class="line">                encoding = sys.stdout.encoding</span><br><span class="line">                print(line.encode(encoding, errors=&#x27;backslashreplace&#x27;).decode(encoding), end=eol)</span><br><span class="line">#            sys.stdout.flush()</span><br><span class="line">        if self.fOut != self.STDOUT:</span><br><span class="line">            self.fOut.write(line + &#x27;\n&#x27;)</span><br><span class="line">            self.fOut.flush()</span><br><span class="line"></span><br><span class="line">    def Line(self, line, eol=&#x27;\n&#x27;):</span><br><span class="line">        if self.head:</span><br><span class="line">            if self.headCounter &lt; 10:</span><br><span class="line">                self.LineSub(line, eol)</span><br><span class="line">            elif self.tail:</span><br><span class="line">                self.tailQueue = self.tailQueue[-9:] + [[line, eol]]</span><br><span class="line">            self.headCounter += 1</span><br><span class="line">        elif self.tail:</span><br><span class="line">            self.tailQueue = self.tailQueue[-9:] + [[line, eol]]</span><br><span class="line">        else:</span><br><span class="line">            self.LineSub(line, eol)</span><br><span class="line"></span><br><span class="line">    def LineTimestamped(self, line):</span><br><span class="line">        self.Line(&#x27;%s: %s&#x27; % (self.FormatTime(), line))</span><br><span class="line"></span><br><span class="line">    def WriteBinary(self, data):</span><br><span class="line">        self.Open(True)</span><br><span class="line">        if self.fOut != self.STDOUT:</span><br><span class="line">            self.fOut.write(data)</span><br><span class="line">            self.fOut.flush()</span><br><span class="line">        else:</span><br><span class="line">            IfWIN32SetBinary(sys.stdout)</span><br><span class="line">            StdoutWriteChunked(data)</span><br><span class="line"></span><br><span class="line">    def CSVWriteRow(self, row):</span><br><span class="line">        if self.oCsvWriter == None:</span><br><span class="line">            self.StringIOCSV = StringIO()</span><br><span class="line">#            self.oCsvWriter = csv.writer(self.fOut)</span><br><span class="line">            self.oCsvWriter = csv.writer(self.StringIOCSV)</span><br><span class="line">        self.oCsvWriter.writerow(row)</span><br><span class="line">        self.Line(self.StringIOCSV.getvalue(), &#x27;&#x27;)</span><br><span class="line">        self.StringIOCSV.truncate(0)</span><br><span class="line">        self.StringIOCSV.seek(0)</span><br><span class="line"></span><br><span class="line">    def Filename(self, filename, index, total):</span><br><span class="line">        self.separateFilename = filename</span><br><span class="line">        if self.progress:</span><br><span class="line">            if index == 0:</span><br><span class="line">                eta = &#x27;&#x27;</span><br><span class="line">            else:</span><br><span class="line">                seconds = int(float((time.time() - self.starttime) / float(index)) * float(total - index))</span><br><span class="line">                eta = &#x27;estimation %d seconds left, finished %s &#x27; % (seconds, self.FormatTime(time.time() + seconds))</span><br><span class="line">            PrintError(&#x27;%d/%d %s%s&#x27; % (index + 1, total, eta, self.separateFilename))</span><br><span class="line">        if self.separateFiles and self.filename != &#x27;&#x27;:</span><br><span class="line">            oFilenameVariables = cVariables()</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;f&#x27;, self.separateFilename)</span><br><span class="line">            basename = os.path.basename(self.separateFilename)</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;b&#x27;, basename)</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;d&#x27;, os.path.dirname(self.separateFilename))</span><br><span class="line">            root, extension = os.path.splitext(basename)</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;r&#x27;, root)</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;ru&#x27;, self.RootUnique(root))</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;e&#x27;, extension)</span><br><span class="line"></span><br><span class="line">            self.Close()</span><br><span class="line">            self.fOut = open(oFilenameVariables.Instantiate(self.filename), self.fileoptions)</span><br><span class="line"></span><br><span class="line">    def Close(self):</span><br><span class="line">        if self.head and self.tail and len(self.tailQueue) &gt; 0:</span><br><span class="line">            self.LineSub(&#x27;...&#x27;, &#x27;\n&#x27;)</span><br><span class="line"></span><br><span class="line">        for line, eol in self.tailQueue:</span><br><span class="line">            self.LineSub(line, eol)</span><br><span class="line"></span><br><span class="line">        self.headCounter = 0</span><br><span class="line">        self.tailQueue = []</span><br><span class="line"></span><br><span class="line">        if self.fOut != self.STDOUT:</span><br><span class="line">            self.fOut.close()</span><br><span class="line">            self.fOut = None</span><br><span class="line"></span><br><span class="line">def InstantiateCOutput(options):</span><br><span class="line">    filenameOption = None</span><br><span class="line">    if options.output != &#x27;&#x27;:</span><br><span class="line">        filenameOption = options.output</span><br><span class="line">    return cOutput(filenameOption)</span><br><span class="line"></span><br><span class="line">def RSAEncrypt(key, data):</span><br><span class="line">    oPublicKey = Crypto.PublicKey.RSA.importKey(binascii.a2b_hex(key).rstrip(b&#x27;\x00&#x27;))</span><br><span class="line">    oRSAPublicKey = Crypto.Cipher.PKCS1_v1_5.new(oPublicKey)</span><br><span class="line">    ciphertext = oRSAPublicKey.encrypt(data)</span><br><span class="line">    ciphertextBASE64 = binascii.b2a_base64(ciphertext).rstrip(b&#x27;\n&#x27;)</span><br><span class="line">    return ciphertextBASE64</span><br><span class="line"></span><br><span class="line">def RSADecrypt(key, data):</span><br><span class="line">    oPrivateKey = Crypto.PublicKey.RSA.importKey(binascii.a2b_hex(key))</span><br><span class="line">    oRSAPrivateKey = Crypto.Cipher.PKCS1_v1_5.new(oPrivateKey)</span><br><span class="line">    ciphertext = data</span><br><span class="line">    try:</span><br><span class="line">        cleartext = oRSAPrivateKey.decrypt(ciphertext, None)</span><br><span class="line">        if cleartext == b&#x27;&#x27;:</span><br><span class="line">            return None</span><br><span class="line">    except ValueError:</span><br><span class="line">        return None</span><br><span class="line">    return cleartext</span><br><span class="line"></span><br><span class="line">class cStruct(object):</span><br><span class="line">    def __init__(self, data):</span><br><span class="line">        self.data = data</span><br><span class="line">        self.originaldata = data</span><br><span class="line"></span><br><span class="line">    def Unpack(self, format):</span><br><span class="line">        formatsize = struct.calcsize(format)</span><br><span class="line">        if len(self.data) &lt; formatsize:</span><br><span class="line">            raise Exception(&#x27;Not enough data&#x27;)</span><br><span class="line">        tounpack = self.data[:formatsize]</span><br><span class="line">        self.data = self.data[formatsize:]</span><br><span class="line">        return struct.unpack(format, tounpack)</span><br><span class="line"></span><br><span class="line">    def Truncate(self, length):</span><br><span class="line">        self.data = self.data[:length]</span><br><span class="line"></span><br><span class="line">    def GetBytes(self, length=None, peek=False):</span><br><span class="line">        if length == None:</span><br><span class="line">            length = len(self.data)</span><br><span class="line">        result = self.data[:length]</span><br><span class="line">        if not peek:</span><br><span class="line">            self.data = self.data[length:]</span><br><span class="line">        return result</span><br><span class="line"></span><br><span class="line">#https://msdn.microsoft.com/en-us/library/windows/desktop/dd317756%28v=vs.85%29.aspx</span><br><span class="line">dCodepages = &#123;</span><br><span class="line">    37: &#x27;IBM EBCDIC US-Canada&#x27;,</span><br><span class="line">    437: &#x27;OEM United States&#x27;,</span><br><span class="line">    500: &#x27;IBM EBCDIC International&#x27;,</span><br><span class="line">    708: &#x27;Arabic (ASMO 708)&#x27;,</span><br><span class="line">    709: &#x27;Arabic (ASMO-449+, BCON V4)&#x27;,</span><br><span class="line">    710: &#x27;Arabic - Transparent Arabic&#x27;,</span><br><span class="line">    720: &#x27;Arabic (Transparent ASMO); Arabic (DOS)&#x27;,</span><br><span class="line">    737: &#x27;OEM Greek (formerly 437G); Greek (DOS)&#x27;,</span><br><span class="line">    775: &#x27;OEM Baltic; Baltic (DOS)&#x27;,</span><br><span class="line">    850: &#x27;OEM Multilingual Latin 1; Western European (DOS)&#x27;,</span><br><span class="line">    852: &#x27;OEM Latin 2; Central European (DOS)&#x27;,</span><br><span class="line">    855: &#x27;OEM Cyrillic (primarily Russian)&#x27;,</span><br><span class="line">    857: &#x27;OEM Turkish; Turkish (DOS)&#x27;,</span><br><span class="line">    858: &#x27;OEM Multilingual Latin 1 + Euro symbol&#x27;,</span><br><span class="line">    860: &#x27;OEM Portuguese; Portuguese (DOS)&#x27;,</span><br><span class="line">    861: &#x27;OEM Icelandic; Icelandic (DOS)&#x27;,</span><br><span class="line">    862: &#x27;OEM Hebrew; Hebrew (DOS)&#x27;,</span><br><span class="line">    863: &#x27;OEM French Canadian; French Canadian (DOS)&#x27;,</span><br><span class="line">    864: &#x27;OEM Arabic; Arabic (864)&#x27;,</span><br><span class="line">    865: &#x27;OEM Nordic; Nordic (DOS)&#x27;,</span><br><span class="line">    866: &#x27;OEM Russian; Cyrillic (DOS)&#x27;,</span><br><span class="line">    869: &#x27;OEM Modern Greek; Greek, Modern (DOS)&#x27;,</span><br><span class="line">    870: &#x27;IBM EBCDIC Multilingual/ROECE (Latin 2); IBM EBCDIC Multilingual Latin 2&#x27;,</span><br><span class="line">    874: &#x27;ANSI/OEM Thai (ISO 8859-11); Thai (Windows)&#x27;,</span><br><span class="line">    875: &#x27;IBM EBCDIC Greek Modern&#x27;,</span><br><span class="line">    932: &#x27;ANSI/OEM Japanese; Japanese (Shift-JIS)&#x27;,</span><br><span class="line">    936: &#x27;ANSI/OEM Simplified Chinese (PRC, Singapore); Chinese Simplified (GB2312)&#x27;,</span><br><span class="line">    949: &#x27;ANSI/OEM Korean (Unified Hangul Code)&#x27;,</span><br><span class="line">    950: &#x27;ANSI/OEM Traditional Chinese (Taiwan; Hong Kong SAR, PRC); Chinese Traditional (Big5)&#x27;,</span><br><span class="line">    1026: &#x27;IBM EBCDIC Turkish (Latin 5)&#x27;,</span><br><span class="line">    1047: &#x27;IBM EBCDIC Latin 1/Open System&#x27;,</span><br><span class="line">    1140: &#x27;IBM EBCDIC US-Canada (037 + Euro symbol); IBM EBCDIC (US-Canada-Euro)&#x27;,</span><br><span class="line">    1141: &#x27;IBM EBCDIC Germany (20273 + Euro symbol); IBM EBCDIC (Germany-Euro)&#x27;,</span><br><span class="line">    1142: &#x27;IBM EBCDIC Denmark-Norway (20277 + Euro symbol); IBM EBCDIC (Denmark-Norway-Euro)&#x27;,</span><br><span class="line">    1143: &#x27;IBM EBCDIC Finland-Sweden (20278 + Euro symbol); IBM EBCDIC (Finland-Sweden-Euro)&#x27;,</span><br><span class="line">    1144: &#x27;IBM EBCDIC Italy (20280 + Euro symbol); IBM EBCDIC (Italy-Euro)&#x27;,</span><br><span class="line">    1145: &#x27;IBM EBCDIC Latin America-Spain (20284 + Euro symbol); IBM EBCDIC (Spain-Euro)&#x27;,</span><br><span class="line">    1146: &#x27;IBM EBCDIC United Kingdom (20285 + Euro symbol); IBM EBCDIC (UK-Euro)&#x27;,</span><br><span class="line">    1147: &#x27;IBM EBCDIC France (20297 + Euro symbol); IBM EBCDIC (France-Euro)&#x27;,</span><br><span class="line">    1148: &#x27;IBM EBCDIC International (500 + Euro symbol); IBM EBCDIC (International-Euro)&#x27;,</span><br><span class="line">    1149: &#x27;IBM EBCDIC Icelandic (20871 + Euro symbol); IBM EBCDIC (Icelandic-Euro)&#x27;,</span><br><span class="line">    1200: &#x27;Unicode UTF-16, little endian byte order (BMP of ISO 10646); available only to managed applications&#x27;,</span><br><span class="line">    1201: &#x27;Unicode UTF-16, big endian byte order; available only to managed applications&#x27;,</span><br><span class="line">    1250: &#x27;ANSI Central European; Central European (Windows)&#x27;,</span><br><span class="line">    1251: &#x27;ANSI Cyrillic; Cyrillic (Windows)&#x27;,</span><br><span class="line">    1252: &#x27;ANSI Latin 1; Western European (Windows)&#x27;,</span><br><span class="line">    1253: &#x27;ANSI Greek; Greek (Windows)&#x27;,</span><br><span class="line">    1254: &#x27;ANSI Turkish; Turkish (Windows)&#x27;,</span><br><span class="line">    1255: &#x27;ANSI Hebrew; Hebrew (Windows)&#x27;,</span><br><span class="line">    1256: &#x27;ANSI Arabic; Arabic (Windows)&#x27;,</span><br><span class="line">    1257: &#x27;ANSI Baltic; Baltic (Windows)&#x27;,</span><br><span class="line">    1258: &#x27;ANSI/OEM Vietnamese; Vietnamese (Windows)&#x27;,</span><br><span class="line">    1361: &#x27;Korean (Johab)&#x27;,</span><br><span class="line">    10000: &#x27;MAC Roman; Western European (Mac)&#x27;,</span><br><span class="line">    10001: &#x27;Japanese (Mac)&#x27;,</span><br><span class="line">    10002: &#x27;MAC Traditional Chinese (Big5); Chinese Traditional (Mac)&#x27;,</span><br><span class="line">    10003: &#x27;Korean (Mac)&#x27;,</span><br><span class="line">    10004: &#x27;Arabic (Mac)&#x27;,</span><br><span class="line">    10005: &#x27;Hebrew (Mac)&#x27;,</span><br><span class="line">    10006: &#x27;Greek (Mac)&#x27;,</span><br><span class="line">    10007: &#x27;Cyrillic (Mac)&#x27;,</span><br><span class="line">    10008: &#x27;MAC Simplified Chinese (GB 2312); Chinese Simplified (Mac)&#x27;,</span><br><span class="line">    10010: &#x27;Romanian (Mac)&#x27;,</span><br><span class="line">    10017: &#x27;Ukrainian (Mac)&#x27;,</span><br><span class="line">    10021: &#x27;Thai (Mac)&#x27;,</span><br><span class="line">    10029: &#x27;MAC Latin 2; Central European (Mac)&#x27;,</span><br><span class="line">    10079: &#x27;Icelandic (Mac)&#x27;,</span><br><span class="line">    10081: &#x27;Turkish (Mac)&#x27;,</span><br><span class="line">    10082: &#x27;Croatian (Mac)&#x27;,</span><br><span class="line">    12000: &#x27;Unicode UTF-32, little endian byte order; available only to managed applications&#x27;,</span><br><span class="line">    12001: &#x27;Unicode UTF-32, big endian byte order; available only to managed applications&#x27;,</span><br><span class="line">    20000: &#x27;CNS Taiwan; Chinese Traditional (CNS)&#x27;,</span><br><span class="line">    20001: &#x27;TCA Taiwan&#x27;,</span><br><span class="line">    20002: &#x27;Eten Taiwan; Chinese Traditional (Eten)&#x27;,</span><br><span class="line">    20003: &#x27;IBM5550 Taiwan&#x27;,</span><br><span class="line">    20004: &#x27;TeleText Taiwan&#x27;,</span><br><span class="line">    20005: &#x27;Wang Taiwan&#x27;,</span><br><span class="line">    20105: &#x27;IA5 (IRV International Alphabet No. 5, 7-bit); Western European (IA5)&#x27;,</span><br><span class="line">    20106: &#x27;IA5 German (7-bit)&#x27;,</span><br><span class="line">    20107: &#x27;IA5 Swedish (7-bit)&#x27;,</span><br><span class="line">    20108: &#x27;IA5 Norwegian (7-bit)&#x27;,</span><br><span class="line">    20127: &#x27;US-ASCII (7-bit)&#x27;,</span><br><span class="line">    20261: &#x27;T.61&#x27;,</span><br><span class="line">    20269: &#x27;ISO 6937 Non-Spacing Accent&#x27;,</span><br><span class="line">    20273: &#x27;IBM EBCDIC Germany&#x27;,</span><br><span class="line">    20277: &#x27;IBM EBCDIC Denmark-Norway&#x27;,</span><br><span class="line">    20278: &#x27;IBM EBCDIC Finland-Sweden&#x27;,</span><br><span class="line">    20280: &#x27;IBM EBCDIC Italy&#x27;,</span><br><span class="line">    20284: &#x27;IBM EBCDIC Latin America-Spain&#x27;,</span><br><span class="line">    20285: &#x27;IBM EBCDIC United Kingdom&#x27;,</span><br><span class="line">    20290: &#x27;IBM EBCDIC Japanese Katakana Extended&#x27;,</span><br><span class="line">    20297: &#x27;IBM EBCDIC France&#x27;,</span><br><span class="line">    20420: &#x27;IBM EBCDIC Arabic&#x27;,</span><br><span class="line">    20423: &#x27;IBM EBCDIC Greek&#x27;,</span><br><span class="line">    20424: &#x27;IBM EBCDIC Hebrew&#x27;,</span><br><span class="line">    20833: &#x27;IBM EBCDIC Korean Extended&#x27;,</span><br><span class="line">    20838: &#x27;IBM EBCDIC Thai&#x27;,</span><br><span class="line">    20866: &#x27;Russian (KOI8-R); Cyrillic (KOI8-R)&#x27;,</span><br><span class="line">    20871: &#x27;IBM EBCDIC Icelandic&#x27;,</span><br><span class="line">    20880: &#x27;IBM EBCDIC Cyrillic Russian&#x27;,</span><br><span class="line">    20905: &#x27;IBM EBCDIC Turkish&#x27;,</span><br><span class="line">    20924: &#x27;IBM EBCDIC Latin 1/Open System (1047 + Euro symbol)&#x27;,</span><br><span class="line">    20932: &#x27;Japanese (JIS 0208-1990 and 0212-1990)&#x27;,</span><br><span class="line">    20936: &#x27;Simplified Chinese (GB2312); Chinese Simplified (GB2312-80)&#x27;,</span><br><span class="line">    20949: &#x27;Korean Wansung&#x27;,</span><br><span class="line">    21025: &#x27;IBM EBCDIC Cyrillic Serbian-Bulgarian&#x27;,</span><br><span class="line">    21027: &#x27;(deprecated)&#x27;,</span><br><span class="line">    21866: &#x27;Ukrainian (KOI8-U); Cyrillic (KOI8-U)&#x27;,</span><br><span class="line">    28591: &#x27;ISO 8859-1 Latin 1; Western European (ISO)&#x27;,</span><br><span class="line">    28592: &#x27;ISO 8859-2 Central European; Central European (ISO)&#x27;,</span><br><span class="line">    28593: &#x27;ISO 8859-3 Latin 3&#x27;,</span><br><span class="line">    28594: &#x27;ISO 8859-4 Baltic&#x27;,</span><br><span class="line">    28595: &#x27;ISO 8859-5 Cyrillic&#x27;,</span><br><span class="line">    28596: &#x27;ISO 8859-6 Arabic&#x27;,</span><br><span class="line">    28597: &#x27;ISO 8859-7 Greek&#x27;,</span><br><span class="line">    28598: &#x27;ISO 8859-8 Hebrew; Hebrew (ISO-Visual)&#x27;,</span><br><span class="line">    28599: &#x27;ISO 8859-9 Turkish&#x27;,</span><br><span class="line">    28603: &#x27;ISO 8859-13 Estonian&#x27;,</span><br><span class="line">    28605: &#x27;ISO 8859-15 Latin 9&#x27;,</span><br><span class="line">    29001: &#x27;Europa 3&#x27;,</span><br><span class="line">    38598: &#x27;ISO 8859-8 Hebrew; Hebrew (ISO-Logical)&#x27;,</span><br><span class="line">    50220: &#x27;ISO 2022 Japanese with no halfwidth Katakana; Japanese (JIS)&#x27;,</span><br><span class="line">    50221: &#x27;ISO 2022 Japanese with halfwidth Katakana; Japanese (JIS-Allow 1 byte Kana)&#x27;,</span><br><span class="line">    50222: &#x27;ISO 2022 Japanese JIS X 0201-1989; Japanese (JIS-Allow 1 byte Kana - SO/SI)&#x27;,</span><br><span class="line">    50225: &#x27;ISO 2022 Korean&#x27;,</span><br><span class="line">    50227: &#x27;ISO 2022 Simplified Chinese; Chinese Simplified (ISO 2022)&#x27;,</span><br><span class="line">    50229: &#x27;ISO 2022 Traditional Chinese&#x27;,</span><br><span class="line">    50930: &#x27;EBCDIC Japanese (Katakana) Extended&#x27;,</span><br><span class="line">    50931: &#x27;EBCDIC US-Canada and Japanese&#x27;,</span><br><span class="line">    50933: &#x27;EBCDIC Korean Extended and Korean&#x27;,</span><br><span class="line">    50935: &#x27;EBCDIC Simplified Chinese Extended and Simplified Chinese&#x27;,</span><br><span class="line">    50936: &#x27;EBCDIC Simplified Chinese&#x27;,</span><br><span class="line">    50937: &#x27;EBCDIC US-Canada and Traditional Chinese&#x27;,</span><br><span class="line">    50939: &#x27;EBCDIC Japanese (Latin) Extended and Japanese&#x27;,</span><br><span class="line">    51932: &#x27;EUC Japanese&#x27;,</span><br><span class="line">    51936: &#x27;EUC Simplified Chinese; Chinese Simplified (EUC)&#x27;,</span><br><span class="line">    51949: &#x27;EUC Korean&#x27;,</span><br><span class="line">    51950: &#x27;EUC Traditional Chinese&#x27;,</span><br><span class="line">    52936: &#x27;HZ-GB2312 Simplified Chinese; Chinese Simplified (HZ)&#x27;,</span><br><span class="line">    54936: &#x27;Windows XP and later: GB18030 Simplified Chinese (4 byte); Chinese Simplified (GB18030)&#x27;,</span><br><span class="line">    57002: &#x27;ISCII Devanagari&#x27;,</span><br><span class="line">    57003: &#x27;ISCII Bengali&#x27;,</span><br><span class="line">    57004: &#x27;ISCII Tamil&#x27;,</span><br><span class="line">    57005: &#x27;ISCII Telugu&#x27;,</span><br><span class="line">    57006: &#x27;ISCII Assamese&#x27;,</span><br><span class="line">    57007: &#x27;ISCII Oriya&#x27;,</span><br><span class="line">    57008: &#x27;ISCII Kannada&#x27;,</span><br><span class="line">    57009: &#x27;ISCII Malayalam&#x27;,</span><br><span class="line">    57010: &#x27;ISCII Gujarati&#x27;,</span><br><span class="line">    57011: &#x27;ISCII Punjabi&#x27;,</span><br><span class="line">    65000: &#x27;Unicode (UTF-7)&#x27;,</span><br><span class="line">    65001: &#x27;Unicode (UTF-8)&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def DecodeMetadata(decrypted, oOutput):</span><br><span class="line">    oStruct = cStruct(decrypted)</span><br><span class="line">    beef = oStruct.Unpack(&#x27;&gt;I&#x27;)[0]</span><br><span class="line">    oOutput.Line(&#x27;Decrypted:&#x27;)</span><br><span class="line">    oOutput.Line(&#x27;Header: %08x&#x27; % beef)</span><br><span class="line">    datasize = oStruct.Unpack(&#x27;&gt;I&#x27;)[0]</span><br><span class="line">    oOutput.Line(&#x27;Datasize: %08x&#x27; % datasize)</span><br><span class="line">    oStruct.Truncate(datasize)</span><br><span class="line">    rawkey = oStruct.GetBytes(16)</span><br><span class="line">    oOutput.Line(&#x27;Raw key:  %s&#x27; % binascii.b2a_hex(rawkey).decode())</span><br><span class="line">    sha256hex = hashlib.sha256(rawkey).hexdigest()</span><br><span class="line">    aeskey = sha256hex[:32]</span><br><span class="line">    hmackey = sha256hex[32:]</span><br><span class="line">    oOutput.Line(&#x27; aeskey:  %s&#x27; % aeskey)</span><br><span class="line">    oOutput.Line(&#x27; hmackey: %s&#x27; % hmackey)</span><br><span class="line">    charset, charset_oem = oStruct.Unpack(&#x27;&lt;HH&#x27;)</span><br><span class="line">    oOutput.Line(&#x27;charset: %04x %s&#x27; % (charset, dCodepages.get(charset, &#x27;&#x27;)))</span><br><span class="line">    oOutput.Line(&#x27;charset_oem: %04x %s&#x27; % (charset_oem, dCodepages.get(charset_oem, &#x27;&#x27;)))</span><br><span class="line"></span><br><span class="line">    peek = oStruct.GetBytes(peek=True)</span><br><span class="line">    if not re.match(b&#x27;[0-9]+\t[0-9]+\t[0-9]&#x27;, peek):</span><br><span class="line">        bid, pid, port, flags = oStruct.Unpack(&#x27;&gt;IIHB&#x27;)</span><br><span class="line">        oOutput.Line(&#x27;bid: %04x %d&#x27; % (bid, bid))</span><br><span class="line">        oOutput.Line(&#x27;pid: %04x %d&#x27; % (pid, pid))</span><br><span class="line">        oOutput.Line(&#x27;port: %d&#x27; % port)</span><br><span class="line">        oOutput.Line(&#x27;flags: %02x&#x27; % flags)</span><br><span class="line"></span><br><span class="line">        peek = oStruct.GetBytes(peek=True)</span><br><span class="line">        if not re.match(b&#x27;[0-9]+\.[0-9]+\t[0-9]+&#x27;, peek):</span><br><span class="line">            var1, var2, var3, var4, var5, var6 = oStruct.Unpack(&#x27;&gt;BBHIII&#x27;)</span><br><span class="line">            oOutput.Line(&#x27;var1: %d&#x27; % var1)</span><br><span class="line">            oOutput.Line(&#x27;var2: %d&#x27; % var2)</span><br><span class="line">            oOutput.Line(&#x27;var3: %d&#x27; % var3)</span><br><span class="line">            oOutput.Line(&#x27;var4: %d&#x27; % var4)</span><br><span class="line">            oOutput.Line(&#x27;var5: %d&#x27; % var5)</span><br><span class="line">            oOutput.Line(&#x27;var6: %d&#x27; % var6)</span><br><span class="line">            ipv4 = oStruct.GetBytes(4)</span><br><span class="line">            oOutput.Line(&#x27;Internal IPv4: %s&#x27; % &#x27;.&#x27;.join([str(byte) for byte in ipv4[::-1]]))</span><br><span class="line"></span><br><span class="line">    remainder = oStruct.GetBytes()</span><br><span class="line">    for field in remainder.split(b&#x27;\t&#x27;):</span><br><span class="line">        oOutput.Line(&#x27;Field: %s&#x27; % field)</span><br><span class="line">    oOutput.Line(&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">def GetScriptPath():</span><br><span class="line">    if getattr(sys, &#x27;frozen&#x27;, False):</span><br><span class="line">        return os.path.dirname(sys.executable)</span><br><span class="line">    else:</span><br><span class="line">        return os.path.dirname(sys.argv[0])</span><br><span class="line"></span><br><span class="line">def GetJSONData():</span><br><span class="line">    filename = os.path.join(GetScriptPath(), &#x27;1768.json&#x27;)</span><br><span class="line">    if not os.path.isfile(filename):</span><br><span class="line">        return &#123;&#125;</span><br><span class="line">    return json.load(open(filename, &#x27;r&#x27;))</span><br><span class="line"></span><br><span class="line">class cCSInstructions(object):</span><br><span class="line">    CS_INSTRUCTION_TYPE_INPUT = &#x27;Input&#x27;</span><br><span class="line">    CS_INSTRUCTION_TYPE_OUTPUT = &#x27;Output&#x27;</span><br><span class="line">    CS_INSTRUCTION_TYPE_METADATA = &#x27;Metadata&#x27;</span><br><span class="line">    CS_INSTRUCTION_TYPE_SESSIONID = &#x27;SessionId&#x27;</span><br><span class="line"></span><br><span class="line">    CS_INSTRUCTION_NONE = 0</span><br><span class="line">    CS_INSTRUCTION_APPEND = 1</span><br><span class="line">    CS_INSTRUCTION_PREPEND = 2</span><br><span class="line">    CS_INSTRUCTION_BASE64 = 3</span><br><span class="line">    CS_INSTRUCTION_PRINT = 4</span><br><span class="line">    CS_INSTRUCTION_PARAMETER = 5</span><br><span class="line">    CS_INSTRUCTION_HEADER = 6</span><br><span class="line">    CS_INSTRUCTION_BUILD = 7</span><br><span class="line">    CS_INSTRUCTION_NETBIOS = 8</span><br><span class="line">    CS_INSTRUCTION_CONST_PARAMETER = 9</span><br><span class="line">    CS_INSTRUCTION_CONST_HEADER = 10</span><br><span class="line">    CS_INSTRUCTION_NETBIOSU = 11</span><br><span class="line">    CS_INSTRUCTION_URI_APPEND = 12</span><br><span class="line">    CS_INSTRUCTION_BASE64URL = 13</span><br><span class="line">    CS_INSTRUCTION_STRREP = 14</span><br><span class="line">    CS_INSTRUCTION_MASK = 15</span><br><span class="line">    CS_INSTRUCTION_CONST_HOST_HEADER = 16</span><br><span class="line"></span><br><span class="line">    def __init__(self, instructionType, instructions):</span><br><span class="line">        self.instructionType = instructionType</span><br><span class="line">        self.instructions = instructions</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def StartsWithGetRemainder(strIn, strStart):</span><br><span class="line">        if strIn.startswith(strStart):</span><br><span class="line">            return True, strIn[len(strStart):]</span><br><span class="line">        else:</span><br><span class="line">            return False, None</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def BASE64URLDecode(data):</span><br><span class="line">        paddingLength = 4 - len(data) % 4</span><br><span class="line">        if paddingLength &lt;= 2:</span><br><span class="line">            data += b&#x27;=&#x27; * paddingLength</span><br><span class="line">        return base64.b64decode(data, b&#x27;-_&#x27;)</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def NETBIOSDecode(netbios):</span><br><span class="line">        dTranslate = &#123;</span><br><span class="line">            ord(b&#x27;A&#x27;): ord(b&#x27;0&#x27;),</span><br><span class="line">            ord(b&#x27;B&#x27;): ord(b&#x27;1&#x27;),</span><br><span class="line">            ord(b&#x27;C&#x27;): ord(b&#x27;2&#x27;),</span><br><span class="line">            ord(b&#x27;D&#x27;): ord(b&#x27;3&#x27;),</span><br><span class="line">            ord(b&#x27;E&#x27;): ord(b&#x27;4&#x27;),</span><br><span class="line">            ord(b&#x27;F&#x27;): ord(b&#x27;5&#x27;),</span><br><span class="line">            ord(b&#x27;G&#x27;): ord(b&#x27;6&#x27;),</span><br><span class="line">            ord(b&#x27;H&#x27;): ord(b&#x27;7&#x27;),</span><br><span class="line">            ord(b&#x27;I&#x27;): ord(b&#x27;8&#x27;),</span><br><span class="line">            ord(b&#x27;J&#x27;): ord(b&#x27;9&#x27;),</span><br><span class="line">            ord(b&#x27;K&#x27;): ord(b&#x27;A&#x27;),</span><br><span class="line">            ord(b&#x27;L&#x27;): ord(b&#x27;B&#x27;),</span><br><span class="line">            ord(b&#x27;M&#x27;): ord(b&#x27;C&#x27;),</span><br><span class="line">            ord(b&#x27;N&#x27;): ord(b&#x27;D&#x27;),</span><br><span class="line">            ord(b&#x27;O&#x27;): ord(b&#x27;E&#x27;),</span><br><span class="line">            ord(b&#x27;P&#x27;): ord(b&#x27;F&#x27;),</span><br><span class="line">        &#125;</span><br><span class="line">        return binascii.a2b_hex(bytes([dTranslate[char] for char in netbios]))</span><br><span class="line"></span><br><span class="line">    def GetInstructions(self):</span><br><span class="line">        for result in self.instructions.split(&#x27;;&#x27;):</span><br><span class="line">            match, remainder = __class__.StartsWithGetRemainder(result, &#x27;7:%s,&#x27; % self.instructionType)</span><br><span class="line">            if match:</span><br><span class="line">                if self.instructionType in [__class__.CS_INSTRUCTION_TYPE_OUTPUT, __class__.CS_INSTRUCTION_TYPE_METADATA]:</span><br><span class="line">                    return &#x27;,&#x27;.join(remainder.split(&#x27;,&#x27;)[::-1])</span><br><span class="line">                else:</span><br><span class="line">                    return remainder</span><br><span class="line">        return &#x27;&#x27;</span><br><span class="line"></span><br><span class="line">    def ProcessInstructions(self, rawdata):</span><br><span class="line">        instructions = self.GetInstructions()</span><br><span class="line">        if instructions == &#x27;&#x27;:</span><br><span class="line">            instructions = []</span><br><span class="line">        else:</span><br><span class="line">            instructions = [instruction for instruction in instructions.split(&#x27;,&#x27;)]</span><br><span class="line">        data = rawdata</span><br><span class="line">        for instruction in instructions:</span><br><span class="line">            instruction = instruction.split(&#x27;:&#x27;)</span><br><span class="line">            opcode = int(instruction[0])</span><br><span class="line">            operands = instruction[1:]</span><br><span class="line">            if opcode == __class__.CS_INSTRUCTION_NONE:</span><br><span class="line">                pass</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_APPEND:</span><br><span class="line">                if self.instructionType == __class__.CS_INSTRUCTION_TYPE_METADATA:</span><br><span class="line">                    data = data[:-len(operands[0])]</span><br><span class="line">                else:</span><br><span class="line">                    data = data[:-int(operands[0])]</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_PREPEND:</span><br><span class="line">                if self.instructionType == __class__.CS_INSTRUCTION_TYPE_METADATA:</span><br><span class="line">                    data = data[len(operands[0]):]</span><br><span class="line">                else:</span><br><span class="line">                    data = data[int(operands[0]):]</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_BASE64:</span><br><span class="line">                data = binascii.a2b_base64(data)</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_PRINT:</span><br><span class="line">                pass</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_PARAMETER:</span><br><span class="line">                pass</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_HEADER:</span><br><span class="line">                pass</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_BUILD:</span><br><span class="line">                pass</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_NETBIOS:</span><br><span class="line">                data = __class__.NETBIOSDecode(data.upper())</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_CONST_PARAMETER:</span><br><span class="line">                pass</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_CONST_HEADER:</span><br><span class="line">                pass</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_NETBIOSU:</span><br><span class="line">                data = __class__.NETBIOSDecode(data)</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_URI_APPEND:</span><br><span class="line">                pass</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_BASE64URL:</span><br><span class="line">                data = __class__.BASE64URLDecode(data)</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_STRREP:</span><br><span class="line">                data = data.replace(operands[0], operands[1])</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_MASK:</span><br><span class="line">                xorkey = data[0:4]</span><br><span class="line">                ciphertext = data[4:]</span><br><span class="line">                data = []</span><br><span class="line">                for iter, value in enumerate(ciphertext):</span><br><span class="line">                    data.append(value ^ xorkey[iter % 4])</span><br><span class="line">                data = bytes(data)</span><br><span class="line">            elif opcode == __class__.CS_INSTRUCTION_CONST_HOST_HEADER:</span><br><span class="line">                pass</span><br><span class="line">            else:</span><br><span class="line">                raise Exception(&#x27;Unknown instruction opcode: %d&#x27; % opcode)</span><br><span class="line">        return data</span><br><span class="line"></span><br><span class="line">def GeneratePEM(hexkey, header):</span><br><span class="line">    result = []</span><br><span class="line">    result.append(&#x27;-----BEGIN %s-----&#x27; % header)</span><br><span class="line">    if hexkey.endswith(&#x27;0000000000&#x27;):</span><br><span class="line">        hexkey = hexkey.rstrip(&#x27;00&#x27;)</span><br><span class="line">    base64 = binascii.b2a_base64(binascii.a2b_hex(hexkey)).decode().rstrip(&#x27;\n&#x27;).rstrip(&#x27;\r&#x27;)</span><br><span class="line">    while len(base64) &gt; 0:</span><br><span class="line">        result.append(base64[:64])</span><br><span class="line">        base64 = base64[64:]</span><br><span class="line">    result.append(&#x27;-----END %s-----&#x27; % header)</span><br><span class="line">    return &#x27;\n&#x27;.join(result)</span><br><span class="line"></span><br><span class="line">def DecryptMetadata(arg, options):</span><br><span class="line">    oOutput = InstantiateCOutput(options)</span><br><span class="line"></span><br><span class="line">    oOutput.Line(&#x27;Input: %s&#x27; % arg)</span><br><span class="line">    arg = cCSInstructions(cCSInstructions.CS_INSTRUCTION_TYPE_METADATA, options.transform).ProcessInstructions(arg.encode())</span><br><span class="line">    oOutput.Line(&#x27;Encrypted metadata: %s&#x27; % binascii.b2a_hex(arg).decode())</span><br><span class="line"></span><br><span class="line">    if options.private != &#x27;&#x27;:</span><br><span class="line">        decrypted = RSADecrypt(options.private, arg)</span><br><span class="line">        if decrypted != None:</span><br><span class="line">            DecodeMetadata(decrypted, oOutput)</span><br><span class="line">    elif options.file != &#x27;&#x27;:</span><br><span class="line">        if javaobj == None:</span><br><span class="line">            print(&#x27;javaobj module required: pip install javaobj-py3&#x27;)</span><br><span class="line">            exit(-1)</span><br><span class="line">        pobj = javaobj.load(open(options.file, &#x27;rb&#x27;))</span><br><span class="line">        privateKey = binascii.b2a_hex(bytes([number &amp; 0xFF for number in pobj.array.value.privateKey.encoded._data])).decode()</span><br><span class="line">        decrypted = RSADecrypt(privateKey, arg)</span><br><span class="line">        if decrypted != None:</span><br><span class="line">            DecodeMetadata(decrypted, oOutput)</span><br><span class="line">    else:</span><br><span class="line">        jsonData = GetJSONData()</span><br><span class="line">        if jsonData == &#123;&#125;:</span><br><span class="line">            print(&#x27;File 1768.json is missing&#x27;)</span><br><span class="line">            return</span><br><span class="line">        for publicKey, dPrivatekey in jsonData[&#x27;dLookupValues&#x27;][&#x27;7&#x27;].items():</span><br><span class="line">            privateKey = dPrivatekey[&#x27;verbose&#x27;]</span><br><span class="line">            decrypted = RSADecrypt(privateKey, arg)</span><br><span class="line">            if decrypted != None:</span><br><span class="line">                DecodeMetadata(decrypted, oOutput)</span><br><span class="line">                if options.verbose:</span><br><span class="line">                    oOutput.Line(&#x27;Public key:&#x27;)</span><br><span class="line">                    oOutput.Line(publicKey)</span><br><span class="line">                    oOutput.Line(GeneratePEM(publicKey, &#x27;RSA PUBLIC KEY&#x27;))</span><br><span class="line">                    oOutput.Line(&#x27;Private key:&#x27;)</span><br><span class="line">                    oOutput.Line(privateKey)</span><br><span class="line">                    oOutput.Line(GeneratePEM(privateKey, &#x27;RSA PRIVATE KEY&#x27;))</span><br><span class="line">                    oOutput.Line(&#x27;Decrypted data:&#x27;)</span><br><span class="line">                    oOutput.Line(binascii.b2a_hex(decrypted).decode())</span><br><span class="line">                break</span><br><span class="line"></span><br><span class="line">def Main():</span><br><span class="line">    moredesc = &#x27;&#x27;&#x27;</span><br><span class="line">Source code put in the public domain by Didier Stevens, no Copyright</span><br><span class="line">Use at your own risk</span><br><span class="line">https://DidierStevens.com&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">    oParser = optparse.OptionParser(usage=&#x27;usage: %prog [options] encrypted_metadata\n&#x27; + __description__ + moredesc, version=&#x27;%prog &#x27; + __version__)</span><br><span class="line">    oParser.add_option(&#x27;-m&#x27;, &#x27;--man&#x27;, action=&#x27;store_true&#x27;, default=False, help=&#x27;Print manual&#x27;)</span><br><span class="line">    oParser.add_option(&#x27;-o&#x27;, &#x27;--output&#x27;, type=str, default=&#x27;&#x27;, help=&#x27;Output to file (# supported)&#x27;)</span><br><span class="line">    oParser.add_option(&#x27;-p&#x27;, &#x27;--private&#x27;, default=&#x27;&#x27;, help=&#x27;Private key (hexadecimal)&#x27;)</span><br><span class="line">    oParser.add_option(&#x27;-f&#x27;, &#x27;--file&#x27;, default=&#x27;&#x27;, help=&#x27;File with private key&#x27;)</span><br><span class="line">    oParser.add_option(&#x27;-t&#x27;, &#x27;--transform&#x27;, type=str, default=&#x27;7:Metadata,3&#x27;, help=&#x27;Transformation instructions&#x27;)</span><br><span class="line">    oParser.add_option(&#x27;-V&#x27;, &#x27;--verbose&#x27;, action=&#x27;store_true&#x27;, default=False, help=&#x27;Verbose mode&#x27;)</span><br><span class="line">    (options, args) = oParser.parse_args()</span><br><span class="line"></span><br><span class="line">    if options.man:</span><br><span class="line">        oParser.print_help()</span><br><span class="line">        PrintManual()</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    if len(args) == 0:</span><br><span class="line">        oParser.print_help()</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    for arg in args:</span><br><span class="line">        DecryptMetadata(arg, options)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    Main()</span><br></pre></td></tr></table></figure>
<p>base64转十六进制网站<br><a target="_blank" rel="noopener" href="https://tool.hiofd.com/base64-convert-hex-online/">在线Base64转16进制工具 - 在线工具网</a><br>设置参数，运行得<br><img src="image-20250331222837822.png"><br>0x03 解密cs流量<br>最后用cs-parse-http-traffic.py解密cs流量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line">from __future__ import print_function</span><br><span class="line"></span><br><span class="line">__description__ = &#x27;Analyze Cobalt Strike HTTP beacon traffic&#x27;</span><br><span class="line">__author__ = &#x27;Didier Stevens&#x27;</span><br><span class="line">__version__ = &#x27;0.0.2&#x27;</span><br><span class="line">__date__ = &#x27;2021/11/05&#x27;</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">Source code put in the public domain by Didier Stevens, no Copyright</span><br><span class="line">https://DidierStevens.com</span><br><span class="line">Use at your own risk</span><br><span class="line"></span><br><span class="line">History:</span><br><span class="line">  2021/04/17: start</span><br><span class="line">  2021/04/18: continue</span><br><span class="line">  2021/04/19: added option -r</span><br><span class="line">  2021/04/20: added option -Y; continue</span><br><span class="line">  2021/04/22: continue</span><br><span class="line">  2021/04/23: continue</span><br><span class="line">  2021/04/24: continue</span><br><span class="line">  2021/10/07: updated missing modules logic</span><br><span class="line">  2021/10/17: 0.0.2 added option -i; -r unknown and -k unknown</span><br><span class="line">  2021/10/28: handle fake gzip</span><br><span class="line">  2021/10/30: continue instructions processing</span><br><span class="line">  2021/10/31: added request methods</span><br><span class="line">  2021/11/01: refactoring instructions processing</span><br><span class="line">  2021/11/05: refactoring instructions processing</span><br><span class="line"></span><br><span class="line">Todo:</span><br><span class="line">  </span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">import optparse</span><br><span class="line">import glob</span><br><span class="line">import collections</span><br><span class="line">import time</span><br><span class="line">import sys</span><br><span class="line">import textwrap</span><br><span class="line">import os</span><br><span class="line">import binascii</span><br><span class="line">import struct</span><br><span class="line">import hashlib</span><br><span class="line">import hmac</span><br><span class="line">import base64</span><br><span class="line">try:</span><br><span class="line">    import pyshark</span><br><span class="line">except ImportError:</span><br><span class="line">    print(&#x27;pyshark module required: pip install pyshark&#x27;)</span><br><span class="line">    exit(-1)</span><br><span class="line">try:</span><br><span class="line">    import Crypto.Cipher.AES</span><br><span class="line">except ImportError:</span><br><span class="line">    print(&#x27;Crypto.Cipher.AES module required: pip install pycryptodome&#x27;)</span><br><span class="line">    exit(-1)</span><br><span class="line"></span><br><span class="line">CS_FIXED_IV = b&#x27;abcdefghijklmnop&#x27;</span><br><span class="line"></span><br><span class="line">def PrintManual():</span><br><span class="line">    manual = &#x27;&#x27;&#x27;</span><br><span class="line">Manual:</span><br><span class="line"></span><br><span class="line">This tool is to be defined.</span><br><span class="line"></span><br><span class="line"># https://github.com/nccgroup/pybeacon</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">    for line in manual.split(&#x27;\n&#x27;):</span><br><span class="line">        print(textwrap.fill(line))</span><br><span class="line"></span><br><span class="line">BEACON_COMMAND_SLEEP = 4</span><br><span class="line">BEACON_COMMAND_DATA_JITTER = 6</span><br><span class="line">BEACON_COMMAND_RUN = 78</span><br><span class="line"></span><br><span class="line">BEACON_COMMANDS = &#123;</span><br><span class="line">    BEACON_COMMAND_SLEEP:  &#x27;SLEEP&#x27;,</span><br><span class="line">    BEACON_COMMAND_DATA_JITTER:  &#x27;DATA_JITTER&#x27;,</span><br><span class="line">    11: &#x27;DOWNLOAD_START&#x27;,</span><br><span class="line">    32: &#x27;LIST_PROCESSES&#x27;,</span><br><span class="line"></span><br><span class="line">    3: &#x27;EXIT&#x27;,</span><br><span class="line">    5: &#x27;CD&#x27;,</span><br><span class="line">    8: &#x27;CHECKIN&#x27;,</span><br><span class="line">    11: &#x27;DOWNLOAD&#x27;,</span><br><span class="line">    12: &#x27;EXECUTE&#x27;,</span><br><span class="line">    13: &#x27;Tasked beacon to spawn features to default process&#x27;,</span><br><span class="line">    27: &#x27;GETUID&#x27;,</span><br><span class="line">    28: &#x27;REVERT_TOKEN&#x27;,</span><br><span class="line">    33: &#x27;KILL&#x27;,</span><br><span class="line">    39: &#x27;PWD&#x27;,</span><br><span class="line">    41: &#x27;JOBS&#x27;,</span><br><span class="line">    48: &#x27;IP_CONFIG&#x27;,</span><br><span class="line">    53: &#x27;LIST_FILES&#x27;,</span><br><span class="line">    54: &#x27;MKDIR&#x27;,</span><br><span class="line">    55: &#x27;DRIVES&#x27;,</span><br><span class="line">    56: &#x27;RM&#x27;,</span><br><span class="line">    72: &#x27;SETENV&#x27;,</span><br><span class="line">    73: &#x27;CP&#x27;,</span><br><span class="line">    74: &#x27;MV&#x27;,</span><br><span class="line">    77: &#x27;GETPRIVS&#x27;,</span><br><span class="line">    BEACON_COMMAND_RUN: &#x27;RUN&#x27;,</span><br><span class="line">    80: &#x27;DLLLOAD&#x27;,</span><br><span class="line">    85: &#x27;ARGUE&#x27;,</span><br><span class="line">    95: &#x27;GETSYSTEM&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">BEACON_OUTPUT = &#123;</span><br><span class="line">    1: &#x27;OUTPUT_KEYSTROKES&#x27;,</span><br><span class="line">    2: &#x27;DOWNLOAD_START&#x27;,</span><br><span class="line">    3: &#x27;OUTPUT_SCREENSHOT&#x27;,</span><br><span class="line">    4: &#x27;SOCKS_DIE&#x27;,</span><br><span class="line">    5: &#x27;SOCKS_WRITE&#x27;,</span><br><span class="line">    6: &#x27;SOCKS_RESUME&#x27;,</span><br><span class="line">    7: &#x27;SOCKS_PORTFWD&#x27;,</span><br><span class="line">    8: &#x27;DOWNLOAD_WRITE&#x27;,</span><br><span class="line">    9: &#x27;DOWNLOAD_COMPLETE&#x27;,</span><br><span class="line">    10: &#x27;BEACON_LINK&#x27;,</span><br><span class="line">    11: &#x27;DEAD_PIPE&#x27;,</span><br><span class="line">    12: &#x27;BEACON_CHECKIN&#x27;, # maybe?</span><br><span class="line">    13: &#x27;BEACON_ERROR&#x27;,</span><br><span class="line">    14: &#x27;PIPES_REGISTER&#x27;, # unsure?</span><br><span class="line">    15: &#x27;BEACON_IMPERSONATED&#x27;,</span><br><span class="line">    16: &#x27;BEACON_GETUID&#x27;,</span><br><span class="line">    17: &#x27;BEACON_OUTPUT_PS&#x27;,</span><br><span class="line">    18: &#x27;ERROR_CLOCK_SKEW&#x27;,</span><br><span class="line">    19: &#x27;BEACON_GETCWD&#x27;,</span><br><span class="line">    20: &#x27;BEACON_OUTPUT_JOBS&#x27;,</span><br><span class="line">    21: &#x27;BEACON_OUTPUT_HASHES&#x27;,</span><br><span class="line">    22: &#x27;TODO&#x27;, # find out</span><br><span class="line">    23: &#x27;SOCKS_ACCEPT&#x27;,</span><br><span class="line">    24: &#x27;BEACON_OUTPUT_NET&#x27;,</span><br><span class="line">    25: &#x27;BEACON_OUTPUT_PORTSCAN&#x27;,</span><br><span class="line">    26: &#x27;BEACON_EXIT&#x27;,</span><br><span class="line">    30: &#x27;OUTPUT&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">class cOutput():</span><br><span class="line">    def __init__(self, filenameOption=None):</span><br><span class="line">        self.starttime = time.time()</span><br><span class="line">        self.filenameOption = filenameOption</span><br><span class="line">        self.separateFiles = False</span><br><span class="line">        self.progress = False</span><br><span class="line">        self.console = False</span><br><span class="line">        self.fOut = None</span><br><span class="line">        self.rootFilenames = &#123;&#125;</span><br><span class="line">        if self.filenameOption:</span><br><span class="line">            if self.ParseHash(self.filenameOption):</span><br><span class="line">                if not self.separateFiles and self.filename != &#x27;&#x27;:</span><br><span class="line">                    self.fOut = open(self.filename, &#x27;w&#x27;)</span><br><span class="line">            elif self.filenameOption != &#x27;&#x27;:</span><br><span class="line">                self.fOut = open(self.filenameOption, &#x27;w&#x27;)</span><br><span class="line">        self.dReplacements = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    def Replace(self, line):</span><br><span class="line">        for key, value in self.dReplacements.items():</span><br><span class="line">            line = line.replace(key, value)</span><br><span class="line">        return line</span><br><span class="line"></span><br><span class="line">    def ParseHash(self, option):</span><br><span class="line">        if option.startswith(&#x27;#&#x27;):</span><br><span class="line">            position = self.filenameOption.find(&#x27;#&#x27;, 1)</span><br><span class="line">            if position &gt; 1:</span><br><span class="line">                switches = self.filenameOption[1:position]</span><br><span class="line">                self.filename = self.filenameOption[position + 1:]</span><br><span class="line">                for switch in switches:</span><br><span class="line">                    if switch == &#x27;s&#x27;:</span><br><span class="line">                        self.separateFiles = True</span><br><span class="line">                    elif switch == &#x27;p&#x27;:</span><br><span class="line">                        self.progress = True</span><br><span class="line">                    elif switch == &#x27;c&#x27;:</span><br><span class="line">                        self.console = True</span><br><span class="line">                    elif switch == &#x27;l&#x27;:</span><br><span class="line">                        pass</span><br><span class="line">                    elif switch == &#x27;g&#x27;:</span><br><span class="line">                        if self.filename != &#x27;&#x27;:</span><br><span class="line">                            extra = self.filename + &#x27;-&#x27;</span><br><span class="line">                        else:</span><br><span class="line">                            extra = &#x27;&#x27;</span><br><span class="line">                        self.filename = &#x27;%s-%s%s.txt&#x27; % (os.path.splitext(os.path.basename(sys.argv[0]))[0], extra, self.FormatTime())</span><br><span class="line">                    else:</span><br><span class="line">                        return False</span><br><span class="line">                return True</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def FormatTime(epoch=None):</span><br><span class="line">        if epoch == None:</span><br><span class="line">            epoch = time.time()</span><br><span class="line">        return &#x27;%04d%02d%02d-%02d%02d%02d&#x27; % time.localtime(epoch)[0:6]</span><br><span class="line"></span><br><span class="line">    def RootUnique(self, root):</span><br><span class="line">        if not root in self.rootFilenames:</span><br><span class="line">            self.rootFilenames[root] = None</span><br><span class="line">            return root</span><br><span class="line">        iter = 1</span><br><span class="line">        while True:</span><br><span class="line">            newroot = &#x27;%s_%04d&#x27; % (root, iter)</span><br><span class="line">            if not newroot in self.rootFilenames:</span><br><span class="line">                self.rootFilenames[newroot] = None</span><br><span class="line">                return newroot</span><br><span class="line">            iter += 1</span><br><span class="line"></span><br><span class="line">    def Line(self, line, eol=&#x27;\n&#x27;):</span><br><span class="line">        line = self.Replace(line)</span><br><span class="line">        if self.fOut == None or self.console:</span><br><span class="line">            try:</span><br><span class="line">                print(line, end=eol)</span><br><span class="line">            except UnicodeEncodeError:</span><br><span class="line">                encoding = sys.stdout.encoding</span><br><span class="line">                print(line.encode(encoding, errors=&#x27;backslashreplace&#x27;).decode(encoding), end=eol)</span><br><span class="line">#            sys.stdout.flush()</span><br><span class="line">        if self.fOut != None:</span><br><span class="line">            self.fOut.write(line + &#x27;\n&#x27;)</span><br><span class="line">            self.fOut.flush()</span><br><span class="line"></span><br><span class="line">    def LineTimestamped(self, line):</span><br><span class="line">        self.Line(&#x27;%s: %s&#x27; % (self.FormatTime(), line))</span><br><span class="line"></span><br><span class="line">    def Filename(self, filename, index, total):</span><br><span class="line">        self.separateFilename = filename</span><br><span class="line">        if self.progress:</span><br><span class="line">            if index == 0:</span><br><span class="line">                eta = &#x27;&#x27;</span><br><span class="line">            else:</span><br><span class="line">                seconds = int(float((time.time() - self.starttime) / float(index)) * float(total - index))</span><br><span class="line">                eta = &#x27;estimation %d seconds left, finished %s &#x27; % (seconds, self.FormatTime(time.time() + seconds))</span><br><span class="line">            PrintError(&#x27;%d/%d %s%s&#x27; % (index + 1, total, eta, self.separateFilename))</span><br><span class="line">        if self.separateFiles and self.filename != &#x27;&#x27;:</span><br><span class="line">            oFilenameVariables = cVariables()</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;f&#x27;, self.separateFilename)</span><br><span class="line">            basename = os.path.basename(self.separateFilename)</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;b&#x27;, basename)</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;d&#x27;, os.path.dirname(self.separateFilename))</span><br><span class="line">            root, extension = os.path.splitext(basename)</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;r&#x27;, root)</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;ru&#x27;, self.RootUnique(root))</span><br><span class="line">            oFilenameVariables.SetVariable(&#x27;e&#x27;, extension)</span><br><span class="line"></span><br><span class="line">            self.Close()</span><br><span class="line">            self.fOut = open(oFilenameVariables.Instantiate(self.filename), &#x27;w&#x27;)</span><br><span class="line"></span><br><span class="line">    def Close(self):</span><br><span class="line">        if self.fOut != None:</span><br><span class="line">            self.fOut.close()</span><br><span class="line">            self.fOut = None</span><br><span class="line"></span><br><span class="line">def InstantiateCOutput(options):</span><br><span class="line">    filenameOption = None</span><br><span class="line">    if options.output != &#x27;&#x27;:</span><br><span class="line">        filenameOption = options.output</span><br><span class="line">    return cOutput(filenameOption)</span><br><span class="line"></span><br><span class="line">def Unpack(format, data):</span><br><span class="line">    size = struct.calcsize(format)</span><br><span class="line">    result = list(struct.unpack(format, data[:size]))</span><br><span class="line">    result.append(data[size:])</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">def FormatTime(epoch=None):</span><br><span class="line">    if epoch == None:</span><br><span class="line">        epoch = time.time()</span><br><span class="line">    return &#x27;%04d%02d%02d-%02d%02d%02d&#x27; % time.gmtime(epoch)[0:6]</span><br><span class="line"></span><br><span class="line">def ExtractPayload(data, options):</span><br><span class="line">    if options.extract:</span><br><span class="line">        with open(&#x27;payload-%s.vir&#x27; % hashlib.md5(data).hexdigest(), &#x27;wb&#x27;) as fWrite:</span><br><span class="line">            fWrite.write(data)</span><br><span class="line"></span><br><span class="line">class cCrypto(object):</span><br><span class="line"></span><br><span class="line">    def __init__(self, rawkey=&#x27;&#x27;, hmacaeskeys=&#x27;&#x27;):</span><br><span class="line">        self.rawkey = rawkey</span><br><span class="line">        self.hmacaeskeys = hmacaeskeys</span><br><span class="line">        if self.rawkey != &#x27;&#x27; and self.rawkey != &#x27;unknown&#x27;:</span><br><span class="line">            sha256digest = hashlib.sha256(binascii.a2b_hex(self.rawkey)).digest()</span><br><span class="line">            self.hmackey = sha256digest[16:]</span><br><span class="line">            self.aeskey = sha256digest[:16]</span><br><span class="line">        elif self.hmacaeskeys != &#x27;&#x27; and self.hmacaeskeys != &#x27;unknown&#x27;:</span><br><span class="line">            self.hmackey = binascii.a2b_hex(self.hmacaeskeys.split(&#x27;:&#x27;)[0])</span><br><span class="line">            self.aeskey = binascii.a2b_hex(self.hmacaeskeys.split(&#x27;:&#x27;)[1])</span><br><span class="line">        else:</span><br><span class="line">            self.hmackey = None</span><br><span class="line">            self.aeskey = None</span><br><span class="line"></span><br><span class="line">    def Decrypt(self, data):</span><br><span class="line">        if self.aeskey == None:</span><br><span class="line">            return data</span><br><span class="line">        encryptedData = data[:-16]</span><br><span class="line">        hmacSignatureMessage = data[-16:]</span><br><span class="line">        hmacsSgnatureCalculated = hmac.new(self.hmackey, encryptedData, hashlib.sha256).digest()[:16]</span><br><span class="line">        if hmacSignatureMessage != hmacsSgnatureCalculated:</span><br><span class="line">            raise Exception(&#x27;HMAC signature invalid&#x27;)</span><br><span class="line">        cypher = Crypto.Cipher.AES.new(self.aeskey, Crypto.Cipher.AES.MODE_CBC, CS_FIXED_IV)</span><br><span class="line">        decryptedData = cypher.decrypt(encryptedData)</span><br><span class="line">        return decryptedData</span><br><span class="line"></span><br><span class="line">    def Encrypt(self, data):</span><br><span class="line">        cypher = Crypto.Cipher.AES.new(self.aeskey, Crypto.Cipher.AES.MODE_CBC, CS_FIXED_IV)</span><br><span class="line">        encryptedData = cypher.encrypt(data)</span><br><span class="line">        hmacsSgnatureCalculated = hmac.new(self.hmackey, encryptedData, hashlib.sha256).digest()[:16]</span><br><span class="line">        return encryptedData + hmacsSgnatureCalculated</span><br><span class="line"></span><br><span class="line">class cStruct(object):</span><br><span class="line">    def __init__(self, data):</span><br><span class="line">        self.data = data</span><br><span class="line">        self.originaldata = data</span><br><span class="line"></span><br><span class="line">    def Unpack(self, format):</span><br><span class="line">        formatsize = struct.calcsize(format)</span><br><span class="line">        if len(self.data) &lt; formatsize:</span><br><span class="line">            raise Exception(&#x27;Not enough data&#x27;)</span><br><span class="line">        tounpack = self.data[:formatsize]</span><br><span class="line">        self.data = self.data[formatsize:]</span><br><span class="line">        result = struct.unpack(format, tounpack)</span><br><span class="line">        if len(result) == 1:</span><br><span class="line">            return result[0]</span><br><span class="line">        else:</span><br><span class="line">            return result</span><br><span class="line"></span><br><span class="line">    def Truncate(self, length):</span><br><span class="line">        self.data = self.data[:length]</span><br><span class="line">        </span><br><span class="line">    def GetBytes(self, length=None):</span><br><span class="line">        if length == None:</span><br><span class="line">            length = len(self.data)</span><br><span class="line">        result = self.data[:length]</span><br><span class="line">        self.data = self.data[length:]</span><br><span class="line">        return result</span><br><span class="line"></span><br><span class="line">    def GetString(self, format):</span><br><span class="line">        stringLength = self.Unpack(format)</span><br><span class="line">        return self.GetBytes(stringLength)</span><br><span class="line"></span><br><span class="line">    def Length(self):</span><br><span class="line">        return len(self.data)</span><br><span class="line"></span><br><span class="line">def BASE64URLDecode(data):</span><br><span class="line">    paddingLength = 4 - len(data) % 4</span><br><span class="line">    if paddingLength &lt;= 2:</span><br><span class="line">        data += b&#x27;=&#x27; * paddingLength</span><br><span class="line">    return base64.b64decode(data, b&#x27;-_&#x27;)</span><br><span class="line"></span><br><span class="line">def StartsWithGetRemainder(strIn, strStart):</span><br><span class="line">    if strIn.startswith(strStart):</span><br><span class="line">        return True, strIn[len(strStart):]</span><br><span class="line">    else:</span><br><span class="line">        return False, None</span><br><span class="line">    </span><br><span class="line">def GetInstructions(instructions, instructionType):</span><br><span class="line">    for result in instructions.split(&#x27;;&#x27;):</span><br><span class="line">        match, remainder = StartsWithGetRemainder(result, &#x27;7:%s,&#x27; % instructionType)</span><br><span class="line">        if match:</span><br><span class="line">            if instructionType == &#x27;Output&#x27;:</span><br><span class="line">                return &#x27;,&#x27;.join(remainder.split(&#x27;,&#x27;)[::-1])</span><br><span class="line">            else:</span><br><span class="line">                return remainder</span><br><span class="line">    return &#x27;&#x27;</span><br><span class="line"></span><br><span class="line">def ProcessInstructions(instructions, rawdata, instructionType):</span><br><span class="line">    instructions = GetInstructions(instructions, instructionType)</span><br><span class="line">    if instructions == &#x27;&#x27;:</span><br><span class="line">        instructions = []</span><br><span class="line">    else:</span><br><span class="line">        instructions = [instruction for instruction in instructions.split(&#x27;,&#x27;)]</span><br><span class="line">    data = rawdata</span><br><span class="line">    for instruction in instructions:</span><br><span class="line">        instruction = instruction.split(&#x27;:&#x27;)</span><br><span class="line">        opcode = int(instruction[0])</span><br><span class="line">        operands = instruction[1:]</span><br><span class="line">        if opcode == 1:</span><br><span class="line">            data = data[:-int(operands[0])]</span><br><span class="line">        elif opcode == 2:</span><br><span class="line">            data = data[int(operands[0]):]</span><br><span class="line">        elif opcode == 3:</span><br><span class="line">            data = binascii.a2b_base64(data)</span><br><span class="line">        elif opcode == 4:</span><br><span class="line">            pass</span><br><span class="line">        elif opcode == 7:</span><br><span class="line">            pass</span><br><span class="line">        elif opcode == 13:</span><br><span class="line">            data = BASE64URLDecode(data)</span><br><span class="line">        elif opcode == 15:</span><br><span class="line">            xorkey = data[0:4]</span><br><span class="line">            ciphertext = data[4:]</span><br><span class="line">            data = []</span><br><span class="line">            for iter, value in enumerate(ciphertext):</span><br><span class="line">                data.append(value ^ xorkey[iter % 4])</span><br><span class="line">            data = bytes(data)</span><br><span class="line">    return data</span><br><span class="line">            </span><br><span class="line">def ProcessReplyPacketData(hexdata, oOutput, oCrypto, dCommandsSummary, options):</span><br><span class="line">    rawdata = binascii.a2b_hex(hexdata)</span><br><span class="line">    oOutput.Line(&#x27;Length raw data: %s&#x27; % len(rawdata))</span><br><span class="line">    rawdata = ProcessInstructions(options.transform, rawdata, &#x27;Input&#x27;)</span><br><span class="line">    if rawdata == b&#x27;&#x27;:</span><br><span class="line">        oOutput.Line(&#x27;No data&#x27;)</span><br><span class="line">        oOutput.Line(&#x27;&#x27;)</span><br><span class="line">        return</span><br><span class="line">    if options.rawkey == &#x27;unknown&#x27; or options.hmacaeskeys == &#x27;unknown&#x27;:</span><br><span class="line">        oOutput.Line(binascii.b2a_hex(rawdata).decode())</span><br><span class="line">        oOutput.Line(&#x27;&#x27;)</span><br><span class="line">        return</span><br><span class="line">    try:</span><br><span class="line">        data = oCrypto.Decrypt(rawdata)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        if e.args != (&#x27;HMAC signature invalid&#x27;,):</span><br><span class="line">            raise</span><br><span class="line">        oOutput.Line(&#x27;HMAC signature invalid&#x27;)</span><br><span class="line">        return</span><br><span class="line">    if data == b&#x27;&#x27;:</span><br><span class="line">        oOutput.Line(&#x27;No data&#x27;)</span><br><span class="line">    elif data.startswith(b&#x27;MZ&#x27;):</span><br><span class="line">        oOutput.Line(&#x27;MZ payload detected&#x27;)</span><br><span class="line">        oOutput.Line(&#x27; MD5: &#x27; + hashlib.md5(data).hexdigest())</span><br><span class="line">        ExtractPayload(data, options)</span><br><span class="line">    else:</span><br><span class="line">        timestamp, datasize, data = Unpack(&#x27;&gt;II&#x27;, data)</span><br><span class="line">        oOutput.Line(&#x27;Timestamp: %d %s&#x27; % (timestamp, FormatTime(timestamp)))</span><br><span class="line">        oOutput.Line(&#x27;Data size: %d&#x27; % datasize)</span><br><span class="line">        data = data[:datasize]</span><br><span class="line">        while len(data) &gt; 0:</span><br><span class="line">            command, argslen, data =  Unpack(&#x27;&gt;II&#x27;, data)</span><br><span class="line">            dCommandsSummary[command] = dCommandsSummary.get(command, 0) + 1</span><br><span class="line">            oOutput.Line(&#x27;Command: %d %s&#x27; % (command, BEACON_COMMANDS.get(command, &#x27;UNKNOWN&#x27;)))</span><br><span class="line">            if command == BEACON_COMMAND_SLEEP:</span><br><span class="line">                sleep, jitter, _ = Unpack(&#x27;&gt;II&#x27;, data)</span><br><span class="line">                oOutput.Line(&#x27; Sleep: %d&#x27; % sleep)</span><br><span class="line">                oOutput.Line(&#x27; Jitter: %d&#x27; % jitter)</span><br><span class="line">            elif command == BEACON_COMMAND_DATA_JITTER:</span><br><span class="line">                oOutput.Line(&#x27; Length random data = %d&#x27; % argslen)</span><br><span class="line">            elif command == BEACON_COMMAND_RUN:</span><br><span class="line">                payload = data[:argslen]</span><br><span class="line">                oStruct = cStruct(payload)</span><br><span class="line">                oOutput.Line(&#x27; Command: %s&#x27; % oStruct.GetString(&#x27;&gt;I&#x27;))</span><br><span class="line">                oOutput.Line(&#x27; Arguments: %s&#x27; % oStruct.GetString(&#x27;&gt;I&#x27;))</span><br><span class="line">                oOutput.Line(&#x27; Integer: %d&#x27; % oStruct.Unpack(&#x27;&gt;H&#x27;))</span><br><span class="line">            else:</span><br><span class="line">                oOutput.Line(&#x27; Arguments length: %d&#x27; % argslen)</span><br><span class="line">                if argslen &gt; 0:</span><br><span class="line">                    if command in [40, 62]:</span><br><span class="line">                        payload = data[:argslen]</span><br><span class="line">                        oStruct = cStruct(payload)</span><br><span class="line">                        oOutput.Line(&#x27; Unknown1: %d&#x27; % oStruct.Unpack(&#x27;&gt;I&#x27;))</span><br><span class="line">                        oOutput.Line(&#x27; Unknown2: %d&#x27; % oStruct.Unpack(&#x27;&gt;I&#x27;))</span><br><span class="line">                        oOutput.Line(&#x27; Pipename: %s&#x27; % oStruct.GetString(&#x27;&gt;I&#x27;))</span><br><span class="line">                        oOutput.Line(&#x27; Command: %s&#x27; % oStruct.GetString(&#x27;&gt;I&#x27;))</span><br><span class="line">                        oOutput.Line(&#x27; &#x27; + repr(oStruct.GetBytes()))</span><br><span class="line">                    else:</span><br><span class="line">                        oOutput.Line(&#x27; &#x27; + repr(data[:argslen])[:100])</span><br><span class="line">                        payload = data[:argslen]</span><br><span class="line">                        oOutput.Line(&#x27; MD5: &#x27; + hashlib.md5(payload).hexdigest())</span><br><span class="line">                        ExtractPayload(payload, options)</span><br><span class="line">            data = data[argslen:]</span><br><span class="line"></span><br><span class="line">    oOutput.Line(&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">def ProcessPostPacketDataSub(data, oOutput, oCrypto, dCallbacksSummary, options):</span><br><span class="line">    oStructData = cStruct(oCrypto.Decrypt(data))</span><br><span class="line">    counter = oStructData.Unpack(&#x27;&gt;I&#x27;)</span><br><span class="line">    oOutput.Line(&#x27;Counter: %d&#x27; % counter)</span><br><span class="line">    oStructCallbackdata = cStruct(oStructData.GetString(&#x27;&gt;I&#x27;))</span><br><span class="line">    callback = oStructCallbackdata.Unpack(&#x27;&gt;I&#x27;)</span><br><span class="line">    callbackdata = oStructCallbackdata.GetBytes()</span><br><span class="line">    oStructCallbackdataToParse = cStruct(callbackdata)</span><br><span class="line">    oOutput.Line(&#x27;Callback: %d %s&#x27; % (callback, BEACON_OUTPUT.get(callback, &#x27;UNKNOWN&#x27;)))</span><br><span class="line">    dCallbacksSummary[callback] = dCallbacksSummary.get(callback, 0) + 1</span><br><span class="line">    if callback in [0, 25]:</span><br><span class="line">        oOutput.Line(&#x27;-&#x27; * 100)</span><br><span class="line">        oOutput.Line(callbackdata.decode())</span><br><span class="line">        oOutput.Line(&#x27;-&#x27; * 100)</span><br><span class="line">    elif callback == 22:</span><br><span class="line">        oOutput.Line(repr(callbackdata[:4]))</span><br><span class="line">        oOutput.Line(&#x27;-&#x27; * 100)</span><br><span class="line">        oOutput.Line(callbackdata[4:].decode(&#x27;latin&#x27;))</span><br><span class="line">        oOutput.Line(&#x27;-&#x27; * 100)</span><br><span class="line">    elif callback == 2:</span><br><span class="line">        parameter1, length = oStructCallbackdataToParse.Unpack(&#x27;&gt;II&#x27;)</span><br><span class="line">        filenameDownload = oStructCallbackdataToParse.GetBytes()</span><br><span class="line">        oOutput.Line(&#x27; parameter1: %d&#x27; % parameter1)</span><br><span class="line">        oOutput.Line(&#x27; length: %d&#x27; % length)</span><br><span class="line">        oOutput.Line(&#x27; filenameDownload: %s&#x27; % filenameDownload.decode())</span><br><span class="line">    elif callback in [17, 30, 32]:</span><br><span class="line">        oOutput.Line(callbackdata.decode())</span><br><span class="line">    elif callback in [3, 8]:</span><br><span class="line">        oOutput.Line(&#x27; Length: %d&#x27; % len(callbackdata[4:]))</span><br><span class="line">        oOutput.Line(&#x27; MD5: &#x27; + hashlib.md5(callbackdata[4:]).hexdigest())</span><br><span class="line">        ExtractPayload(callbackdata[4:], options)</span><br><span class="line">    else:</span><br><span class="line">        oOutput.Line(repr(callbackdata))</span><br><span class="line">    extradata = oStructData.GetBytes()[:-16] # drop hmac</span><br><span class="line">    if len(extradata) &gt; 0:</span><br><span class="line">        oOutput.Line(&#x27;Extra packet data: %s&#x27; % repr(extradata))</span><br><span class="line"></span><br><span class="line">    oOutput.Line(&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">def ProcessPostPacketData(hexdata, oOutput, oCrypto, dCallbacksSummary, options):</span><br><span class="line">    rawdata = binascii.a2b_hex(hexdata)</span><br><span class="line">    oOutput.Line(&#x27;Length raw data: %s&#x27; % len(rawdata))</span><br><span class="line">    rawdata = ProcessInstructions(options.transform, rawdata, &#x27;Output&#x27;)</span><br><span class="line">    if rawdata == b&#x27;&#x27;:</span><br><span class="line">        oOutput.Line(&#x27;No data&#x27;)</span><br><span class="line">        oOutput.Line(&#x27;&#x27;)</span><br><span class="line">        return</span><br><span class="line">    if options.rawkey == &#x27;unknown&#x27; or options.hmacaeskeys == &#x27;unknown&#x27;:</span><br><span class="line">        oOutput.Line(binascii.b2a_hex(rawdata).decode())</span><br><span class="line">        oOutput.Line(&#x27;&#x27;)</span><br><span class="line">        return</span><br><span class="line">    oStructData = cStruct(rawdata)</span><br><span class="line">    while oStructData.Length() &gt; 0:</span><br><span class="line">        ProcessPostPacketDataSub(oStructData.GetString(&#x27;&gt;I&#x27;), oOutput, oCrypto, dCallbacksSummary, options)</span><br><span class="line"></span><br><span class="line">def AnalyzeCapture(filename, options):</span><br><span class="line">    oOutput = InstantiateCOutput(options)</span><br><span class="line"></span><br><span class="line">    if options.hmacaeskeys != &#x27;&#x27;:</span><br><span class="line">        oCrypto = cCrypto(hmacaeskeys=options.hmacaeskeys)</span><br><span class="line">    else:</span><br><span class="line">        oCrypto = cCrypto(rawkey=options.rawkey)</span><br><span class="line"></span><br><span class="line">    dMethods = &#123;&#125;</span><br><span class="line">    dCommandsSummary = &#123;&#125;</span><br><span class="line">    dCallbacksSummary = &#123;&#125;</span><br><span class="line">    capture = pyshark.FileCapture(filename, display_filter=options.displayfilter, use_json=True, include_raw=True)</span><br><span class="line">    for packet in capture:</span><br><span class="line">        if not hasattr(packet, &#x27;http&#x27;):</span><br><span class="line">            continue</span><br><span class="line"></span><br><span class="line">        if hasattr(packet.http, &#x27;request&#x27;) and packet.http.has_field(&#x27;1\\r\\n&#x27;): # this is a bug in PyShark, should be fieldname request</span><br><span class="line">            dMethods[packet.number] = packet.http.get_field(&#x27;1\\r\\n&#x27;).method</span><br><span class="line"></span><br><span class="line">        data_raw = None</span><br><span class="line">        if hasattr(packet.http, &#x27;file_data_raw&#x27;):</span><br><span class="line">            data_raw = packet.http.file_data_raw</span><br><span class="line">        elif hasattr(packet.http, &#x27;content-encoded_entity_body_(gzip)&#x27;):</span><br><span class="line">            data_raw = getattr(packet.http, &#x27;content-encoded_entity_body_(gzip)&#x27;).data.data_raw</span><br><span class="line">        else:</span><br><span class="line">            continue</span><br><span class="line"></span><br><span class="line">        if hasattr(packet.http, &#x27;response&#x27;):</span><br><span class="line">            oOutput.Line(&#x27;Packet number: %d&#x27; % packet.number)</span><br><span class="line">            if hasattr(packet.http, &#x27;request_in&#x27;) and len(packet.http.request_in.fields) &gt; 0:</span><br><span class="line">                requestPacket = packet.http.request_in.fields[0].int_value</span><br><span class="line">                oOutput.Line(&#x27;HTTP response (for request %d %s)&#x27; % (requestPacket, dMethods.get(requestPacket, &#x27;&#x27;)))</span><br><span class="line">            else:</span><br><span class="line">                oOutput.Line(&#x27;HTTP response&#x27;)</span><br><span class="line">            ProcessReplyPacketData(data_raw[0], oOutput, oCrypto, dCommandsSummary, options)</span><br><span class="line"></span><br><span class="line">        if hasattr(packet.http, &#x27;request&#x27;):</span><br><span class="line">            oOutput.Line(&#x27;Packet number: %d&#x27; % packet.number)</span><br><span class="line">            oOutput.Line(&#x27;HTTP request %s&#x27; % dMethods.get(packet.number, &#x27;&#x27;))</span><br><span class="line">            oOutput.Line(packet.http.full_uri)</span><br><span class="line">            ProcessPostPacketData(data_raw[0], oOutput, oCrypto, dCallbacksSummary, options)</span><br><span class="line"></span><br><span class="line">    capture.close()</span><br><span class="line"></span><br><span class="line">    if len(dCommandsSummary) &gt; 0:</span><br><span class="line">        oOutput.Line(&#x27;\nCommands summary:&#x27;)</span><br><span class="line">        for command, counter in sorted(dCommandsSummary.items()):</span><br><span class="line">            oOutput.Line(&#x27; %d %s: %d&#x27; % (command, BEACON_COMMANDS.get(command, &#x27;UNKNOWN&#x27;), counter))</span><br><span class="line"></span><br><span class="line">    if len(dCallbacksSummary) &gt; 0:</span><br><span class="line">        oOutput.Line(&#x27;\nCallbacks summary:&#x27;)</span><br><span class="line">        for callback, counter in sorted(dCallbacksSummary.items()):</span><br><span class="line">            oOutput.Line(&#x27; %d %s: %d&#x27; % (callback, BEACON_OUTPUT.get(callback, &#x27;UNKNOWN&#x27;), counter))</span><br><span class="line"></span><br><span class="line">def ProcessArguments(filenames, options):</span><br><span class="line">    for filename in filenames:</span><br><span class="line">        AnalyzeCapture(filename, options)</span><br><span class="line"></span><br><span class="line">def Main():</span><br><span class="line">    moredesc = &#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">Arguments:</span><br><span class="line">@file: process each file listed in the text file specified</span><br><span class="line">wildcards are supported</span><br><span class="line"></span><br><span class="line">Source code put in the public domain by Didier Stevens, no Copyright</span><br><span class="line">Use at your own risk</span><br><span class="line">https://DidierStevens.com&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">    oParser = optparse.OptionParser(usage=&#x27;usage: %prog [options] [[@]file ...]\n&#x27; + __description__ + moredesc, version=&#x27;%prog &#x27; + __version__)</span><br><span class="line">    oParser.add_option(&#x27;-m&#x27;, &#x27;--man&#x27;, action=&#x27;store_true&#x27;, default=False, help=&#x27;Print manual&#x27;)</span><br><span class="line">    oParser.add_option(&#x27;-o&#x27;, &#x27;--output&#x27;, type=str, default=&#x27;&#x27;, help=&#x27;Output to file (# supported)&#x27;)</span><br><span class="line">    oParser.add_option(&#x27;-e&#x27;, &#x27;--extract&#x27;, action=&#x27;store_true&#x27;, default=False, help=&#x27;Extract payloads to disk&#x27;)</span><br><span class="line">    oParser.add_option(&#x27;-r&#x27;, &#x27;--rawkey&#x27;, type=str, default=&#x27;&#x27;, help=&quot;CS beacon&#x27;s raw key&quot;)</span><br><span class="line">    oParser.add_option(&#x27;-k&#x27;, &#x27;--hmacaeskeys&#x27;, type=str, default=&#x27;&#x27;, help=&quot;HMAC and AES keys in hexadecimal separated by :&quot;)</span><br><span class="line">    oParser.add_option(&#x27;-Y&#x27;, &#x27;--displayfilter&#x27;, type=str, default=&#x27;http&#x27;, help=&quot;Tshark display filter (default http)&quot;)</span><br><span class="line">    oParser.add_option(&#x27;-t&#x27;, &#x27;--transform&#x27;, type=str, default=&#x27;&#x27;, help=&#x27;Transformation instructions&#x27;)</span><br><span class="line">    (options, args) = oParser.parse_args()</span><br><span class="line"></span><br><span class="line">    if options.man:</span><br><span class="line">        oParser.print_help()</span><br><span class="line">        PrintManual()</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    ProcessArguments(args, options)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    Main()</span><br></pre></td></tr></table></figure>
<p>这里注意python版本问题，我用python 3.7.9运行失败，换了3.12.6后成功<br>设置参数，运行得<br><img src="image-20250331223101564.png"><br>如果出现编码错误，记得修改编码格式，我这里选择忽略<br><img src="image-20250331223312780.png"><br>但是选择忽略可能会出现字符重复的问题，比如下图<br><img src="image-20250331223328709.png"><br>这里注册表应该是HKEY_CURRENT_USER\Software\Classes\mscfile\……<br>也就是双斜线和单斜线的问题，其他的问题暂时还没发现</p>
<h1 id="0x04-参考资料"><a href="#0x04-参考资料" class="headerlink" title="0x04 参考资料"></a>0x04 参考资料</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_63923205/article/details/146447254">【PolarCTF网络安全2025春季个人挑战赛】个人WP_polar ctf春季2025个人挑战赛-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/DidierStevens/Beta/blob/master/cs-parse-http-traffic.py">Beta&#x2F;cs-parse-http-traffic.py at master · DidierStevens&#x2F;Beta</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/327060.html"># Cobalt Strike：使用已知的私钥解密流量-Part 2 - FreeBuf网络安全行业门户</a></p>
<p><a target="_blank" rel="noopener" href="https://geekdaxue.co/read/jianouzuihuai@tools/cs_decrypt">CobaltStrike - Cobalt Strike - 流量解密脚本 - 《🛠工具库🛠》 - 极客文档</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/AomCC/article/details/133298604">从一道例题分析CS流量解密-CSDN博客</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://gulisf.github.io">gulisf</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://gulisf.github.io/2025/03/31/ji-yi-ci-cs-liu-liang-jie-mi/">https://gulisf.github.io/2025/03/31/ji-yi-ci-cs-liu-liang-jie-mi/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://gulisf.github.io" target="_blank">Gulisf's Home</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/">流量分析</a></div><div class="post-share"><div class="social-share" data-image="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409201930403.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409211212038.png" target="_blank"><img class="post-qr-code-img" src="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409211212038.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409211210571.png" target="_blank"><img class="post-qr-code-img" src="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409211210571.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="next-post pull-full" href="/2025/03/21/bo-ke-da-jian-wen-ti-yu-jie-jue/" title="博客搭建问题与解决"><img class="cover" src="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409201930402.jpg" onerror="onerror=null;src='/imag/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">博客搭建问题与解决</div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/imag/gulisf.jpg" onerror="this.onerror=null;this.src='/imag/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">gulisf</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/gulisf"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E8%8E%B7%E5%8F%96%E5%85%AC%E7%A7%81%E9%92%A5"><span class="toc-text">0x01 获取公私钥</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E8%8E%B7%E5%8F%96key"><span class="toc-text">0x02 获取key</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">0x04 参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/31/ji-yi-ci-cs-liu-liang-jie-mi/" title="记一次CS流量解密"><img src="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409201930403.jpg" onerror="this.onerror=null;this.src='/imag/404.jpg'" alt="记一次CS流量解密"/></a><div class="content"><a class="title" href="/2025/03/31/ji-yi-ci-cs-liu-liang-jie-mi/" title="记一次CS流量解密">记一次CS流量解密</a><time datetime="2025-03-30T16:00:00.000Z" title="发表于 2025-03-31 00:00:00">2025-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/21/bo-ke-da-jian-wen-ti-yu-jie-jue/" title="博客搭建问题与解决"><img src="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409201930402.jpg" onerror="this.onerror=null;this.src='/imag/404.jpg'" alt="博客搭建问题与解决"/></a><div class="content"><a class="title" href="/2025/03/21/bo-ke-da-jian-wen-ti-yu-jie-jue/" title="博客搭建问题与解决">博客搭建问题与解决</a><time datetime="2025-03-20T16:00:00.000Z" title="发表于 2025-03-21 00:00:00">2025-03-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/19/php-fan-xu-lie-hua-yi/" title="php反序列化一"><img src="https://raw.githubusercontent.com/gulisf/guliimage/main/upload/202409201930411.jpg" onerror="this.onerror=null;this.src='/imag/404.jpg'" alt="php反序列化一"/></a><div class="content"><a class="title" href="/2024/09/19/php-fan-xu-lie-hua-yi/" title="php反序列化一">php反序列化一</a><time datetime="2024-09-19T11:43:10.000Z" title="发表于 2024-09-19 19:43:10">2024-09-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By gulisf</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;</p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>